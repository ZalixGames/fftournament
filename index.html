
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nadeem Raza Crypto App - Full History & Selects</title>
    <!-- Google Font Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Variables --- */
        :root {
            /* Refined Color Palette */
            --primary-color: #0052cc; /* Slightly richer blue */
            --primary-light: #0069ff; /* Brighter accent */
            --primary-hover: #0041a3; /* Darker hover */
            --secondary-color: #5a6a7b; /* Softer secondary */
            --secondary-hover: #495664;
            --success-color: #1c8e44; /* Slightly deeper green */
            --success-hover: #156e35;
            --danger-color: #d63031; /* Slightly softer red */
            --danger-hover: #b32829;
            --warning-color: #ffac07; /* Vibrant yellow */
            --warning-hover: #d99000;
            --info-color: #0ca6b9; /* Teal info color */
            --light-bg: #ffffff;
            --body-bg: #f7f8fc; /* Slightly cooler background */
            --card-bg: var(--light-bg);
            --text-dark: #2d3748; /* Darker text for better contrast */
            --text-medium: #4a5568;
            --text-light: #718096;
            --border-color: #e2e8f0; /* Lighter border */
            --card-shadow: 0 4px 12px rgba(0, 82, 204, 0.07); /* Softer shadow */
            --card-hover-shadow: 0 7px 20px rgba(0, 82, 204, 0.1);
            --border-radius: 8px; /* Slightly smaller radius */
            --gradient-primary: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
            --gradient-earn: linear-gradient(135deg, #f8f9fc 0%, #eef3f9 100%); /* Subtle gradient for earn page */
            --gradient-points: linear-gradient(135deg, #ffffff 0%, #f5f9ff 100%);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-medium);
            line-height: 1.65; /* Improved line height */
            padding-bottom: 75px; /* Adjusted for slightly taller nav */
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            font-size: 15px; /* Base font size for mobile */
        }

        /* --- Authentication --- */
        #auth-container {
            max-width: 400px; /* Slightly smaller */
            margin: 50px auto; /* Adjusted margin */
            padding: 35px; /* Adjusted padding */
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            text-align: center;
            border-top: 4px solid var(--primary-color);
        }
        #auth-container h2 {
            margin-bottom: 25px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.6em; /* Slightly smaller */
        }
        #auth-container .form-group {
            margin-bottom: 18px; /* Adjusted spacing */
            text-align: left;
            position: relative;
        }
        #auth-container label {
            display: block;
            margin-bottom: 6px; /* Adjusted spacing */
            font-weight: 500;
            font-size: 0.9em; /* Slightly smaller label */
            color: var(--text-dark);
        }
        #auth-container input[type="email"],
        #auth-container input[type="password"],
        #auth-container input[type="text"] {
            width: 100%;
            padding: 12px 15px; /* Adjusted padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #fdfdff;
        }
        #auth-container .referral-input-group input { padding-left: 38px; }
        #auth-container .referral-input-group .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 1.1em;
        }
        #auth-container input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.15); /* Adjusted focus shadow */
            outline: none;
        }
        #auth-container button[type="submit"] {
            width: 100%;
            padding: 13px; /* Adjusted padding */
            background-image: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.05em; /* Slightly adjusted */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(0, 82, 204, 0.2);
        }
        #auth-container button[type="submit"]:hover {
            background-image: none;
            background-color: var(--primary-hover);
            box-shadow: 0 4px 8px rgba(0, 82, 204, 0.25);
            transform: translateY(-2px);
        }
        #auth-container button:disabled {
            background-image: none;
            background-color: #a0aec0; /* Adjusted disabled color */
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        #auth-container .switch-auth {
            margin-top: 25px; /* Adjusted spacing */
            font-size: 0.9em;
        }
        #auth-container .switch-auth button {
            background: none;
            border: none;
            color: var(--primary-light);
            text-decoration: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
        }
        #auth-container .switch-auth button:hover {
            text-decoration: underline;
            color: var(--primary-hover);
        }
        #auth-error {
            color: var(--danger-color);
            margin-top: 15px;
            font-size: 0.9em;
            min-height: 1.2em;
            font-weight: 500;
        }
        #auth-container label .optional-text {
            font-weight: 400;
            font-size: 0.9em;
            color: var(--text-light);
            margin-left: 5px;
        }
        #signup-form input[readonly] {
             background-color: #e2e8f0 !important;
             cursor: not-allowed !important;
             opacity: 0.7;
        }

        /* --- App Structure & Navigation --- */
        #main-app { display: none; width: 100%; }
        body.logged-in { padding-bottom: 75px; } /* Match nav height */
        #app-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 10px; /* Slightly reduced padding */
            width: 100%;
        }
        .page {
            display: none;
            padding: 20px 5px; /* Adjusted padding */
            animation: fadeIn 0.4s ease-in-out;
            width: 100%;
        }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { /* Page Titles */
            color: var(--text-dark); /* Changed from primary for better balance */
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            font-size: 1.5em; /* Adjusted size */
            font-weight: 600;
        }

        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px; /* Slightly taller for better tap targets */
            background-color: var(--light-bg);
            box-shadow: 0 -3px 12px rgba(0, 0, 0, 0.08); /* Adjusted shadow */
            display: flex;
            justify-content: space-around;
            align-items: stretch; /* Stretch items to fill height */
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }
        #bottom-nav button {
            background: none;
            border: none;
            color: var(--text-light);
            padding: 8px 5px;
            cursor: pointer;
            font-size: 11px; /* Keep text small */
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center content vertically */
            text-align: center;
            flex-grow: 1;
            transition: color 0.2s ease, background-color 0.2s ease;
            height: 100%;
            font-weight: 500;
            border-top: 4px solid transparent; /* Placeholder for active border */
            margin-top: -1px; /* Align top border */
            line-height: 1.3; /* Adjust line height */
        }
        #bottom-nav button svg {
            width: 24px; /* SVG Size */
            height: 24px;
            margin-bottom: 4px; /* Space between icon and text */
            fill: currentColor; /* Use button text color */
            transition: transform 0.2s ease;
        }
        #bottom-nav button:hover {
            color: var(--primary-color);
        }
        #bottom-nav button:hover svg {
            transform: scale(1.1);
        }
        #bottom-nav button.active {
            color: var(--primary-color);
            border-top: 4px solid var(--primary-color);
            font-weight: 600;
            background-color: var(--body-bg); /* Subtle background change */
        }

        /* --- Trading Page --- */
        #page-trading { position: relative; min-height: calc(100vh - 75px); width: 100%; }
        #page-trading .trading-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px; /* Adjusted padding */
            background: var(--gradient-points); /* Use subtle gradient */
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            position: relative;
            border: 1px solid var(--border-color);
        }
        #page-trading .header-info { display: flex; align-items: center; }
        #page-trading .header-logo {
            width: 45px; /* Adjusted size */
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px; /* Adjusted spacing */
            border: 2px solid var(--primary-light);
            background-color: var(--body-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            flex-shrink: 0;
        }
        #page-trading .header-title {
            font-size: 1.15em; /* Adjusted size */
            font-weight: 600;
            color: var(--text-dark);
        }
        /* Coin List */
        #page-trading .coin-list {
            list-style: none;
            padding: 0;
            display: grid;
            gap: 15px; /* Reduced gap */
            grid-template-columns: 1fr; /* Single column on mobile */
            width: 100%;
        }
        /* Larger screens */
        @media (min-width: 600px) {
            #page-trading .coin-list {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px; /* Restore gap */
            }
        }
        #page-trading .coin-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 18px; /* Adjusted padding */
            display: flex;
            flex-direction: column;
            box-shadow: var(--card-shadow);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        #page-trading .coin-item:hover {
            box-shadow: var(--card-hover-shadow);
            transform: translateY(-3px); /* Subtle lift */
        }
        #page-trading .coin-main-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 15px; /* Adjusted spacing */
            flex-wrap: wrap;
            gap: 8px;
        }
        #page-trading .coin-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            margin-right: 10px;
        }
        #page-trading .coin-logo {
            width: 40px; /* Adjusted size */
            height: 40px;
            margin-right: 12px; /* Adjusted spacing */
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #eee;
            background-color: #f8f9fa;
            padding: 2px;
            flex-shrink: 0;
        }
        #page-trading .coin-details { display: flex; flex-direction: column; }
        #page-trading .coin-name {
            font-weight: 600;
            font-size: 1.1em; /* Adjusted size */
            color: var(--text-dark);
        }
        #page-trading .coin-symbol {
            font-size: 0.85em; /* Adjusted size */
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 500;
        }
        #page-trading .price-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }
        #page-trading .coin-price-usd {
            font-size: 1.1em; /* Adjusted size */
            font-weight: 600;
            color: var(--success-color);
        }
        #page-trading .coin-price-pkr {
            font-size: 0.85em; /* Adjusted size */
            color: var(--text-light);
        }
        #page-trading .coin-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            width: 100%;
            gap: 10px;
            margin-top: auto; /* Pushes buttons to bottom */
            padding-top: 12px; /* Adjusted spacing */
            border-top: 1px solid #f1f4f8; /* Lighter separator */
        }
        #page-trading .coin-actions button {
            padding: 8px 16px; /* Adjusted padding */
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.9em; /* Adjusted size */
            font-weight: 500;
            transition: all 0.2s ease;
            flex-grow: 1; /* Make buttons fill space */
            max-width: 100px; /* Limit max width */
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #page-trading .buy-button { background-color: var(--success-color); }
        #page-trading .sell-button { background-color: var(--danger-color); }
        #page-trading .buy-button:hover { background-color: var(--success-hover); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(28, 142, 68, 0.2); }
        #page-trading .sell-button:hover { background-color: var(--danger-hover); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(214, 48, 49, 0.2); }
        #page-trading .coin-actions button:disabled { background-color: #a0aec0; cursor: not-allowed; box-shadow: none; transform: none; }
        #page-trading .realtime-notice {
            text-align: center;
            font-size: 0.85em; /* Adjusted size */
            color: var(--text-light);
            margin-top: 25px;
        }
        /* WhatsApp FAB */
        #whatsapp-fab {
            position: fixed;
            bottom: 85px; /* Above taller nav bar */
            right: 20px; /* Slightly closer */
            width: 55px; /* Adjusted size */
            height: 55px;
            background-color: #fff;
            border-radius: 50%;
            border: none;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); /* Adjusted shadow */
            cursor: pointer;
            z-index: 1005;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease;
            padding: 0;
            overflow: hidden;
        }
        #whatsapp-fab img { width: 100%; height: 100%; object-fit: cover; display: block; }
        #whatsapp-fab:hover { transform: scale(1.08); box-shadow: 0 7px 20px rgba(0, 0, 0, 0.2); }

        /* --- News Page --- */
        #page-news { width: 100%; } #page-news h2 { margin-bottom: 25px; }
        #page-news .news-container {
            display: grid;
            grid-template-columns: 1fr; /* Single column mobile */
            gap: 18px; /* Adjusted gap */
            width: 100%;
        }
        @media (min-width: 600px) {
            #page-news .news-container {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 25px;
            }
        }
        #page-news .news-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid var(--border-color);
        }
        #page-news .news-item:hover {
            box-shadow: var(--card-hover-shadow);
            transform: translateY(-3px);
        }
        #page-news .news-image {
            width: 100%;
            height: 180px; /* Adjusted height */
            object-fit: cover;
            background-color: #e2e8f0;
            border-bottom: 1px solid var(--border-color);
        }
        #page-news .news-content {
            padding: 20px; /* Adjusted padding */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #page-news .news-title {
            font-size: 1.15em; /* Adjusted size */
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            line-height: 1.45;
        }
        #page-news .news-text {
            font-size: 0.95em; /* Adjusted size */
            color: var(--text-medium);
            line-height: 1.7;
            margin-bottom: 15px; /* Adjusted spacing */
            flex-grow: 1;
        }
        #page-news .join-button {
            display: inline-block;
            background-image: var(--gradient-primary);
            color: white;
            text-align: center;
            padding: 10px 18px; /* Adjusted padding */
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9em; /* Adjusted size */
            transition: all 0.3s ease;
            margin-top: auto;
            border: none;
            align-self: flex-start;
            box-shadow: 0 2px 5px rgba(0, 82, 204, 0.2);
        }
        #page-news .join-button:hover {
            background-image: none;
            background-color: var(--primary-hover);
            box-shadow: 0 4px 8px rgba(0, 82, 204, 0.25);
            transform: translateY(-1px);
        }
        #page-news .join-button.disabled {
            background-image: none;
            background-color: #a0aec0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            opacity: 0.7;
        }

        /* --- Earn Page --- */
        #page-earn {
            background: var(--gradient-earn);
            border-radius: var(--border-radius);
            padding: 25px 15px; /* Adjusted padding */
            width: 100%;
        }
        #points-section {
            background: var(--gradient-points);
            border: 1px solid var(--border-color);
            padding: 25px 20px; /* Adjusted padding */
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Adjusted gap */
        }
        #points-section .points-area p {
            margin-bottom: 5px; /* Reduced margin */
            font-size: 1.1em; /* Adjusted size */
            color: var(--text-dark);
            font-weight: 500;
        }
        #points-section .points-area span#points-display {
            font-weight: 700;
            font-size: 2.5em; /* Adjusted size */
            color: var(--primary-color);
            display: block;
            line-height: 1.1;
            background: -webkit-linear-gradient(45deg, var(--primary-light), var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        #points-section .action-buttons {
            display: flex;
            gap: 12px; /* Reduced gap */
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        #withdraw-button, #profile-button-earn, #invite-list-button {
            border: none;
            padding: 10px 20px; /* Adjusted padding */
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em; /* Adjusted size */
            font-weight: 600;
            transition: all 0.2s ease;
            letter-spacing: 0.3px;
            flex-grow: 1;
            max-width: 180px; /* Adjusted max width */
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            text-align: center;
        }
        #withdraw-button { background-color: var(--warning-color); color: var(--text-dark); }
        #profile-button-earn { background-color: var(--primary-light); color: white; }
        #invite-list-button { background-color: var(--secondary-color); color: white; }
        #withdraw-button:hover { background-color: var(--warning-hover); transform: translateY(-2px); box-shadow: 0 3px 7px rgba(255, 172, 7, 0.25); }
        #profile-button-earn:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 3px 7px rgba(0, 82, 204, 0.25); }
        #invite-list-button:hover { background-color: var(--secondary-hover); transform: translateY(-2px); box-shadow: 0 3px 7px rgba(90, 106, 123, 0.25); }
        #withdraw-button:disabled { background-color: #a0aec0; cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }

        /* Task List */
        #page-earn h3 {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 18px;
            font-size: 1.25em; /* Adjusted size */
            text-align: center;
        }
        .task-list { list-style: none; padding: 0; width: 100%; }
        .task-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 18px; /* Adjusted padding */
            margin-bottom: 15px; /* Adjusted spacing */
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            gap: 12px; /* Adjusted gap */
            box-shadow: var(--card-shadow);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        .task-item:hover { box-shadow: var(--card-hover-shadow); transform: translateY(-3px); }
        .task-item .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            width: 100%;
            gap: 5px;
        }
        .task-item span.task-desc {
            flex-grow: 1;
            color: var(--text-dark);
            font-size: 1.05em; /* Adjusted size */
            font-weight: 600;
            margin-right: 10px;
            line-height: 1.4;
        }
        .task-item .task-points {
            font-size: 0.95em; /* Adjusted size */
            color: var(--success-color);
            font-weight: 600;
            white-space: nowrap;
        }
        .task-item .task-actions {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            width: 100%;
            margin-top: 5px;
        }
        .task-item button.task-button, .task-item a.task-button {
            background-color: var(--primary-light);
            color: white;
            padding: 8px 16px; /* Adjusted padding */
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9em; /* Adjusted size */
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
            border: none;
            cursor: pointer;
            letter-spacing: 0.2px;
            box-shadow: 0 1px 3px rgba(0, 105, 255, 0.2);
        }
        .task-item button.task-button:hover, .task-item a.task-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 3px 6px rgba(0, 105, 255, 0.25);
        }
        .task-item button.task-button:disabled {
            background-color: #8a9aaf; /* Adjusted disabled color */
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
            transform: none;
        }
        .task-item .timer-claim-section { display: flex; align-items: center; gap: 10px; }
        .task-item span.timer { font-style: italic; color: var(--text-light); font-size: 0.85em; white-space: nowrap; }
        .task-item .completed-message, .task-item .checked-in-message {
            color: var(--success-color);
            font-weight: 600;
            font-size: 0.9em; /* Adjusted size */
            white-space: nowrap;
            padding: 8px 0; /* Match button padding */
        }
        .task-item .referral-link-area { margin-top: 8px; width: 100%; }
        .task-item input.referral-link-input {
            width: 100%;
            padding: 10px 12px; /* Adjusted padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9em; /* Adjusted size */
            background-color: #f0f4f9; /* Subtle background */
            color: var(--text-medium);
            font-family: inherit;
            margin-bottom: 8px; /* Adjusted spacing */
            display: block;
            overflow-x: hidden; /* Prevent overflow */
            text-overflow: ellipsis; /* Add ellipsis */
        }
        .task-item button.copy-link-button {
            width: 100%;
            padding: 10px 0; /* Adjusted padding */
            border-radius: 6px;
            background-color: var(--secondary-color);
            border: none;
            color: white;
            font-size: 0.9em;
            box-shadow: 0 1px 3px rgba(90, 106, 123, 0.2);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .task-item button.copy-link-button:hover { background-color: var(--secondary-hover); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(90, 106, 123, 0.25); }


        /* --- History Page --- */
         #page-history { width: 100%; padding-bottom: 80px; }
         .history-list { list-style: none; padding: 0; width: 100%; }
         .history-item {
             background-color: var(--card-bg);
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             padding: 16px; /* Adjusted padding */
             margin-bottom: 12px; /* Adjusted spacing */
             box-shadow: var(--card-shadow);
             display: flex;
             flex-direction: column;
             gap: 8px; /* Adjusted gap */
         }
         .history-item-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             border-bottom: 1px solid #f1f4f8; /* Lighter separator */
             padding-bottom: 8px;
             margin-bottom: 8px;
             flex-wrap: wrap;
             gap: 5px;
         }
         .history-item-type {
             font-size: 1.05em; /* Adjusted size */
             font-weight: 600;
             color: var(--primary-color);
             flex-shrink: 0;
         }
         .history-item-date {
             font-size: 0.8em; /* Adjusted size */
             color: var(--text-light);
             white-space: nowrap;
         }
         .history-item-details { line-height: 1.55; } /* Adjusted line height */
         .history-item-details p {
             margin-bottom: 4px; /* Adjusted spacing */
             font-size: 0.9em; /* Adjusted size */
             color: var(--text-medium);
             word-break: break-all;
             display: flex; /* Align strong and value */
             justify-content: space-between;
             flex-wrap: wrap; /* Allow wrap on small screens */
             gap: 5px;
         }
         .history-item-details strong {
             font-weight: 500;
             color: var(--text-dark);
             margin-right: 5px;
             flex-shrink: 0; /* Prevent label shrinking */
         }
        .history-item-details span { /* Value part */
             text-align: right;
             flex-grow: 1;
             color: var(--text-medium); /* Make value less prominent */
        }
         .history-item-status {
             margin-top: 8px; /* Adjusted spacing */
             padding: 5px 12px; /* Adjusted padding */
             border-radius: 15px; /* Pill shape */
             font-size: 0.75em; /* Adjusted size */
             font-weight: 600;
             text-align: center;
             display: inline-block;
             align-self: flex-end;
             text-transform: uppercase;
             letter-spacing: 0.5px;
             border: 1px solid transparent; /* Base border */
         }
         .status-pending { background-color: #fffbeb; color: #b45309; border-color: #fde68a; } /* Updated status colors */
         .status-completed { background-color: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
         .status-rejected { background-color: #fef2f2; color: #b91c1c; border-color: #fecaca; }
         .no-history {
             text-align: center;
             color: var(--text-light);
             padding: 30px;
             font-style: italic;
             font-size: 1em; /* Adjusted size */
         }


        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(45, 55, 72, 0.75); /* Use dark text color with alpha */
            backdrop-filter: blur(4px); /* Slightly more blur */
            animation: fadeInModal 0.3s ease-out;
        }
        .modal.show { display: flex; justify-content: center; align-items: center; padding: 10px; }
        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px; /* Adjusted padding */
            border: none;
            width: 100%;
            max-width: 500px; /* Adjusted max width */
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); /* Adjusted shadow */
            position: relative;
            animation: slideInModal 0.35s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-button {
            color: #a0aec0; /* Lighter close */
            position: absolute;
            top: 12px; /* Adjusted position */
            right: 15px;
            font-size: 28px; /* Adjusted size */
            font-weight: bold;
            line-height: 1;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            transition: color 0.2s ease;
        }
        .close-button:hover, .close-button:focus { color: var(--text-dark); }
        @keyframes fadeInModal { from { background-color: rgba(45, 55, 72, 0); backdrop-filter: blur(0px); } to { background-color: rgba(45, 55, 72, 0.75); backdrop-filter: blur(4px); } }
        @keyframes slideInModal { from { transform: translateY(-20px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .modal-form h3 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 1.4em; /* Adjusted size */
        }
        .modal-form h4 {
            margin-top: 20px;
            margin-bottom: 12px;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-weight: 600;
            font-size: 1.1em; /* Adjusted size */
        }
        .modal-form .form-group { margin-bottom: 18px; /* Adjusted spacing */ }
        .modal-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 0.9em;
        }
        .modal-form input[type="text"],
        .modal-form input[type="number"],
        .modal-form input[type="file"],
        .modal-form select {
            width: 100%;
            padding: 11px 14px; /* Adjusted padding */
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95em; /* Adjusted size */
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: var(--light-bg); /* Ensure consistent background */
        }
        .modal-form input:focus, .modal-form select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.15);
            outline: none;
        }
        .modal-form input[type="file"] { padding: 9px; background-color: var(--light-bg); }
         /* Style Select Dropdowns */
        .modal-form select {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23718096'><path fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/></svg>"); /* Use text-light color */
            background-repeat: no-repeat;
            background-position: right 0.8rem center;
            background-size: 0.9em;
            padding-right: 2.5rem; /* Make space for arrow */
        }
        .modal-form button[type="submit"] {
            background-color: var(--success-color);
            color: white;
            padding: 12px 20px; /* Adjusted padding */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-size: 1.05em; /* Adjusted size */
            font-weight: 600;
            margin-top: 20px; /* Adjusted spacing */
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(28, 142, 68, 0.25);
        }
        .modal-form button[type="submit"]:hover {
            background-color: var(--success-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(28, 142, 68, 0.3);
        }
        .modal-form button:disabled { background-color: #a0aec0; cursor: not-allowed; box-shadow: none; transform: none; }
        .modal-form .info-text {
            font-size: 0.9em; /* Adjusted size */
            color: var(--text-light);
            margin-bottom: 18px;
            line-height: 1.6;
            background-color: #f0f4f9; /* Subtle background */
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .modal-form .error-message {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: 15px;
            min-height: 1.2em;
            text-align: center;
            font-weight: 500;
        }
        /* Profile Modal */
        #profileModal .profile-info {
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 25px;
        }
        #profileModal .profile-info p {
            margin-bottom: 12px; /* Adjusted spacing */
            font-size: 1em; /* Adjusted size */
            color: var(--text-medium);
            word-break: break-all;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        #profileModal .profile-info p:last-child { margin-bottom: 0; }
        #profileModal .profile-info strong {
            color: var(--text-dark);
            font-weight: 600;
            margin-right: 10px;
            flex-shrink: 0;
        }
        #profileModal .profile-info span {
            text-align: right;
            color: var(--primary-color);
            font-weight: 500;
            word-break: break-all; /* Allow long emails/names to break */
        }
        #profileModal #profile-logout-button-modal {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 11px 18px; /* Adjusted padding */
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(214, 48, 49, 0.25);
        }
        #profileModal #profile-logout-button-modal svg { width: 16px; height: 16px; fill: currentColor; }
        #profileModal #profile-logout-button-modal:hover {
            background-color: var(--danger-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(214, 48, 49, 0.3);
        }
        /* Invite List Modal */
        #inviteListModal .invite-list-content {
            max-height: 350px; /* Adjusted height */
            overflow-y: auto;
            padding-right: 10px;
            margin-top: 15px;
            border: 1px solid var(--border-color); /* Add border */
            border-radius: 6px;
            padding: 10px; /* Add padding */
        }
        #inviteListModal .invite-list-item {
            background-color: #f8fafc; /* Slightly different background */
            padding: 10px 12px; /* Adjusted padding */
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em; /* Adjusted size */
            flex-wrap: wrap;
            gap: 5px;
        }
        #inviteListModal .invite-list-item span:first-child {
            font-weight: 500;
            color: var(--text-dark);
            word-break: break-all;
            flex-basis: 60%; /* Give more space to name/email */
            flex-grow: 1;
        }
        #inviteListModal .invite-list-item span:last-child {
            font-size: 0.9em; /* Relative to parent */
            color: var(--text-light);
            white-space: nowrap;
            flex-shrink: 0;
        }
        #inviteListModal .no-invites { text-align: center; color: var(--text-light); padding: 20px; font-style: italic; }

        /* Dealer Address Section (Sell Modal) */
        .dealer-address-section {
            background-color: #f0f4f9; /* Use subtle background */
            padding: 15px; /* Adjusted padding */
            border-radius: 6px; /* Match inputs */
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .dealer-address-section p {
            margin: 0 0 6px 0;
            font-size: 0.9em; /* Adjusted size */
            color: var(--text-medium);
            line-height: 1.5;
            word-wrap: break-word; /* Use break-word */
        }
        .dealer-address-section strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        .dealer-address-section .address {
            font-weight: 600;
            color: var(--danger-color);
            margin-top: 8px;
            display: block;
            font-family: 'Courier New', Courier, monospace; /* Monospace for address */
            font-size: 1em; /* Adjusted size */
            background-color: #fff;
            padding: 8px 10px;
            border-radius: 4px;
            border: 1px dashed var(--danger-hover); /* Use darker dashed border */
            word-break: break-all;
        }

        /* Banner Ad Container */
        #banner-ad-container {
            width: 100%;
            max-width: 320px;
            margin: 20px auto 0 auto; /* Adjusted margin */
            text-align: center;
            overflow: hidden;
            height: 50px;
            background-color: #e2e8f0; /* Placeholder color */
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex; /* Center potential ad content */
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            color: var(--text-light);
        }

        /* Utility */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.5rem; } .mt-2 { margin-top: 1rem; } .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; } .mb-3 { margin-bottom: 1.5rem; }

    </style>
</head>
<body>

    <!-- Auth Container -->
    <div id="auth-container">
        <!-- Login Form -->
        <form id="login-form"><h2>Welcome Back!</h2><div id="login-error" class="auth-error"></div><div class="form-group"><label for="login-email">Email Address</label><input type="email" id="login-email" required placeholder="you@example.com"></div><div class="form-group"><label for="login-password">Password</label><input type="password" id="login-password" required placeholder="Your Password"></div><button type="submit">Login Securely</button><div class="switch-auth">Don't have an account? <button type="button" onclick="showSignupForm()">Sign Up Now</button></div></form>
        <!-- Signup Form -->
        <form id="signup-form" style="display: none;"><h2>Create Your Account</h2><div id="signup-error" class="auth-error"></div><div class="form-group"><label for="signup-name">Full Name</label><input type="text" id="signup-name" required placeholder="Enter your full name"></div><div class="form-group"><label for="signup-email">Email Address</label><input type="email" id="signup-email" required placeholder="you@example.com"></div><div class="form-group"><label for="signup-password">Create Password</label><input type="password" id="signup-password" required minlength="6" placeholder="Minimum 6 characters"></div><div class="form-group"><label for="signup-confirm-password">Confirm Password</label><input type="password" id="signup-confirm-password" required placeholder="Re-enter your password"></div><div class="form-group referral-input-group"><label for="signup-referral-code">Referral Code <span class="optional-text">(Optional)</span></label><span class="input-icon">ðŸ”—</span><input type="text" id="signup-referral-code" placeholder="Enter code if you have one"></div><button type="submit">Create Account</button><div class="switch-auth">Already have an account? <button type="button" onclick="showLoginForm()">Login Here</button></div></form>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <main id="app-content">
            <!-- Trading Page -->
            <div id="page-trading" class="page">
                <div class="trading-header">
                    <div class="header-info">
                        <img src="https://i.imgur.com/2Ou7g1K.jpeg" alt="Dealer Logo" class="header-logo">
                        <span class="header-title">Nadeem Raza Trust Dealer</span>
                    </div>
                </div>
                <h2>Trading Market</h2>
                <ul class="coin-list">
                    <li class="coin-item" data-coin-id="sidra">
                        <div class="coin-main-info">
                           <div class="coin-info">
                               <img src="https://i.imgur.com/3HnywZh.jpeg" alt="Sidra Chain Logo" class="coin-logo">
                               <div class="coin-details">
                                   <span class="coin-name">Sidra Chain</span>
                                   <span class="coin-symbol">SIDRA</span>
                               </div>
                           </div>
                           <div class="price-section">
                               <span class="coin-price-usd" id="price-sidra-usd">$...</span>
                               <span class="coin-price-pkr" id="price-sidra-pkr">PKR ...</span>
                           </div>
                        </div>
                        <div class="coin-actions">
                           <button class="buy-button" onclick="openBuyModal('Sidra Chain')">Buy</button>
                           <button class="sell-button" onclick="openSellModal('Sidra Chain')">Sell</button>
                        </div>
                    </li>
                    <li class="coin-item" data-coin-id="usdt_trc20">
                        <div class="coin-main-info">
                            <div class="coin-info">
                                <img src="https://i.imgur.com/0g4DwhR.jpeg" alt="USDT Logo" class="coin-logo">
                                <div class="coin-details">
                                    <span class="coin-name">USDT (TRC20)</span>
                                    <span class="coin-symbol">USDT</span>
                                </div>
                            </div>
                            <div class="price-section">
                                <span class="coin-price-usd" id="price-usdt_trc20-usd">$...</span>
                                <span class="coin-price-pkr" id="price-usdt_trc20-pkr">PKR ...</span>
                            </div>
                        </div>
                        <div class="coin-actions">
                            <button class="buy-button" onclick="openBuyModal('USDT (TRC20)')">Buy</button>
                            <button class="sell-button" onclick="openSellModal('USDT (TRC20)')">Sell</button>
                        </div>
                    </li>
                 </ul>
                 <p class="realtime-notice">Prices updated in real-time.</p>
                 <button id="whatsapp-fab" aria-label="Contact us on WhatsApp" onclick="openWhatsApp()">
                     <img src="https://i.imgur.com/d2UlLQN.png" alt="WhatsApp Contact">
                 </button>
             </div>
            <!-- News Page -->
            <div id="page-news" class="page">
                <h2>Crypto News & Projects</h2>
                <div id="news-container" class="news-container">
                    <p class="text-center mt-2">Loading news...</p>
                </div>
            </div>
            <!-- Earn Page -->
            <div id="page-earn" class="page">
                <h2>Earn Points</h2>
                <div id="points-section">
                    <div class="points-area">
                        <p>Your Total Points Balance</p>
                        <span id="points-display">0</span>
                    </div>
                    <div class="action-buttons">
                        <button id="withdraw-button" onclick="openWithdrawModal()">Withdraw Points</button>
                        <button id="profile-button-earn" onclick="openProfileModal()">My Profile</button>
                        <button id="invite-list-button" onclick="openInviteListModal()">My Invites</button>
                    </div>
                </div>
                <h3>Complete Tasks to Earn</h3>
                <ul id="task-list" class="task-list">
                    <li class="task-item" id="task-daily-checkin">
                        <div class="task-header">
                            <span class="task-desc">Daily Check-in Bonus</span>
                            <span class="task-points">+10 Pts</span>
                        </div>
                        <div class="task-actions">
                            <button id="daily-checkin-button" class="task-button" onclick="handleDailyCheckin()">Check-in Now</button>
                        </div>
                    </li>
                    <li class="task-item" id="task-referral">
                        <div class="task-header">
                            <span class="task-desc">Invite Friends & Earn</span>
                            <span class="task-points">+200 Pts / Friend</span>
                        </div>
                        <p style="font-size: 0.9em; color: var(--text-medium); margin: 5px 0;">Share your link. Earn points when friends sign up!</p>
                        <div class="referral-link-area">
                            <input type="text" id="referral-link-input" class="referral-link-input" value="Loading your link..." readonly>
                            <button id="copy-link-button" class="copy-link-button" onclick="copyReferralLink()">Copy Referral Link</button>
                        </div>
                    </li>
                    <div id="dynamic-tasks-loading" class="text-center mt-3 mb-2" style="color: var(--text-light); font-style: italic;">Loading other tasks...</div>
                 </ul>
             </div>
             <!-- History Page -->
             <div id="page-history" class="page">
                 <h2>Transaction History</h2>
                 <div id="history-list-container">
                     <p class="text-center mt-3" id="history-loading-msg">Loading history...</p>
                     <ul class="history-list" id="history-list">
                         <!-- History items loaded by JS -->
                     </ul>
                 </div>
             </div>
        </main>
        <nav id="bottom-nav">
            <button id="btn-trading" onclick="showPage('page-trading', this)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.004 9.414l-8.607 8.607-1.414-1.414L14.589 8H7.004V6h11v11h-2V9.414z"/></svg>
                Trading
            </button>
            <button id="btn-news" onclick="showPage('page-news', this)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16 20V4H4v16h12zm3 1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v18zM6 6h8v2H6V6zm0 4h8v2H6v-2zm0 4h5v2H6v-2z"/></svg>
                News
            </button>
            <button id="btn-earn" onclick="showPage('page-earn', this)">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm-1.5-8.5a1 1 0 0 0-2 0V15a1 1 0 0 0 1 1h.5a1 1 0 0 0 1-1v-1.5zm6-1a1 1 0 0 0-1 1V15a1 1 0 0 0 1 1h.5a1 1 0 0 0 1-1v-1.5a1 1 0 0 0-1-1h-.5zm-3.75-6a1 1 0 0 0-1-1h-.5a1 1 0 0 0-1 1V8a1 1 0 0 0 1 1h.5a1 1 0 0 0 1-1V6.5z"/></svg>
                Earn
            </button>
            <button id="btn-history" onclick="showPage('page-history', this)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2zm0 2a8 8 0 1 0 0 16 8 8 0 0 0 0-16zm1 4h-2v6h6v-2h-4V8z"/></svg>
                History
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <!-- Buy Modal -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('buyModal')">&times;</span>
            <form class="modal-form" id="buyForm" onsubmit="handleBuySubmit(event)">
                <h3>Buy <span id="buyCoinName">Coin</span></h3>
                <div class="form-group">
                    <label for="buyQuantity">Coin Quantity:</label>
                    <input type="number" id="buyQuantity" name="quantity" step="any" required placeholder="e.g., 100">
                </div>
                <div class="form-group">
                    <label for="buyAddress">Your Receiving Address:</label>
                    <input type="text" id="buyAddress" name="receivingAddress" required placeholder="Enter your wallet address">
                </div>
                <!-- Wallet/Exchange Dropdown -->
                <div class="form-group">
                    <label for="buyWallet">Your Wallet / Exchange:</label>
                    <select id="buyWallet" name="walletName" required>
                        <option value="" disabled selected>Select Wallet/Exchange</option>
                        <option value="Binance">Binance</option>
                        <option value="OKX">OKX</option>
                        <option value="Trust Wallet">Trust Wallet</option>
                        <option value="MetaMask">MetaMask</option>
                        <option value="Sidra Chain Wallet">Sidra Chain Wallet</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <h4>Your Payment Information (Proof)</h4>
                <p class="info-text">Send payment to the dealer (obtain details via WhatsApp/Contact) and fill the form below accurately.</p>
                <!-- Payment Method Dropdown -->
                <div class="form-group">
                    <label for="buyPaymentMethod">Payment Method Used:</label>
                     <select id="buyPaymentMethod" name="paymentMethod" required>
                         <option value="" disabled selected>Select Payment Method</option>
                         <option value="Easypaisa">Easypaisa</option>
                         <option value="Jazzcash">Jazzcash</option>
                         <option value="Bank Transfer">Bank Transfer</option>
                         <option value="Other">Other</option>
                     </select>
                </div>
                <div class="form-group">
                    <label for="buyAccountName">Sender Account Name:</label>
                    <input type="text" id="buyAccountName" name="accountName" required placeholder="Your name on the account">
                </div>
                <div class="form-group">
                    <label for="buyAccountNumber">Sender Account Number / IBAN:</label>
                    <input type="text" id="buyAccountNumber" name="accountNumber" required placeholder="Account number used for payment">
                </div>
                <div class="form-group">
                    <label for="buyTxId">Transaction ID / Ref Number:</label>
                    <input type="text" id="buyTxId" name="transactionId" required placeholder="TID or reference number">
                </div>
                <div class="form-group">
                    <label for="buyTxPhoto">Transaction Screenshot (Optional):</label>
                    <input type="file" id="buyTxPhoto" name="transactionPhoto" accept="image/*" >
                    <small style="display: block; margin-top: 4px; color: var(--text-light); font-size: 0.85em;">Upload proof if possible.</small>
                </div>
                <button type="submit">Submit Buy Order</button>
            </form>
        </div>
    </div>

    <!-- Sell Modal -->
    <div id="sellModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('sellModal')">&times;</span>
            <form class="modal-form" id="sellForm" onsubmit="handleSellSubmit(event)">
                <h3>Sell <span id="sellCoinName">Coin</span></h3>
                <div id="dealerAddressInfo" class="dealer-address-section">
                    <p>Loading dealer address...</p>
                </div>
                <div class="form-group">
                    <label for="sellQuantity">Coin Quantity You Are Selling:</label>
                    <input type="number" id="sellQuantity" name="quantity" step="any" required placeholder="e.g., 50">
                </div>
                <div class="form-group">
                    <label for="sellTxHash">Transaction ID / Hash (Crypto Sent):</label>
                    <input type="text" id="sellTxHash" name="cryptoTxHash" placeholder="Enter TxID/Hash after sending crypto" required>
                    <small style="display: block; margin-top: 4px; color: var(--text-medium); font-size: 0.85em;">Ensure you have sent crypto to the address above BEFORE submitting.</small>
                </div>
                <h4>Your Receiving Payment Information</h4>
                <p class="info-text">Enter details where you want to receive payment (e.g., PKR). Double-check for accuracy.</p>
                <!-- Payment Method Dropdown -->
                <div class="form-group">
                    <label for="sellPaymentMethod">Preferred Payment Method:</label>
                     <select id="sellPaymentMethod" name="paymentMethod" required>
                         <option value="" disabled selected>Select Payment Method</option>
                         <option value="Easypaisa">Easypaisa</option>
                         <option value="Jazzcash">Jazzcash</option>
                         <option value="Bank Transfer">Bank Transfer</option>
                         <option value="Other">Other</option>
                     </select>
                </div>
                <div class="form-group">
                    <label for="sellAccountName">Your Account Name:</label>
                    <input type="text" id="sellAccountName" name="accountName" required placeholder="Name on your receiving account">
                </div>
                <div class="form-group">
                    <label for="sellAccountNumber">Your Account Number / IBAN:</label>
                    <input type="text" id="sellAccountNumber" name="accountNumber" required placeholder="Account number for payment">
                </div>
                <button type="submit">Submit Sell Order</button>
            </form>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('withdrawModal')">&times;</span>
            <form class="modal-form" id="withdrawForm" onsubmit="handleWithdrawSubmit(event)">
                <h3>Withdraw Points</h3>
                <div class="info-text text-center" style="background-color: #eef3f9; padding: 12px; border-radius: 6px; border: 1px solid var(--border-color); font-weight: 500;">
                    Available Points: <strong id="withdraw-current-points" style="color: var(--primary-color); font-size: 1.1em;">0</strong><br>
                    <span style="font-size: 0.9em;">Minimum Withdrawal: <strong id="withdraw-minimum-points">10000</strong> Pts</span>
                </div>
                <div id="withdraw-message" class="error-message" style="margin-bottom: 15px;"></div>
                <div class="form-group">
                    <label for="withdraw-amount">Points to Withdraw:</label>
                    <input type="number" id="withdraw-amount" name="amount" min="10000" required placeholder="Enter points (min 10000)">
                </div>
                <div class="form-group">
                    <label for="withdraw-method">Payment Method:</label>
                    <select id="withdraw-method" name="method" required>
                        <option value="" disabled selected>Select Method</option>
                        <option value="Easypaisa">Easypaisa</option>
                        <option value="Jazzcash">Jazzcash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdraw-account-name">Account Holder Name:</label>
                    <input type="text" id="withdraw-account-name" name="accountName" required placeholder="Name on your account">
                </div>
                <div class="form-group">
                    <label for="withdraw-account-number">Account Number:</label>
                    <input type="text" id="withdraw-account-number" name="accountNumber" required placeholder="Easypaisa/Jazzcash/Bank account number">
                </div>
                <button type="submit">Submit Withdrawal Request</button>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
            <h3 class="modal-form">Your Profile</h3>
            <div class="profile-info">
                <p><strong>Name:</strong> <span id="profile-modal-user-name">...</span></p>
                <p><strong>Email:</strong> <span id="profile-modal-user-email">...</span></p>
                <p><strong>Points:</strong> <span id="profile-modal-user-points">...</span></p>
            </div>
            <button id="profile-logout-button-modal" onclick="handleLogout()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor"><path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/></svg>
                Logout
            </button>
        </div>
    </div>

    <!-- Invite List Modal -->
    <div id="inviteListModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('inviteListModal')">&times;</span>
            <h3 class="modal-form">Users You Invited</h3>
            <div id="invite-list-content" class="invite-list-content">
                <p class="no-invites">Loading invite list...</p>
                <!-- Items Added by JS -->
            </div>
        </div>
    </div>

    <!-- Banner Ad Container -->
    <div id="banner-ad-container">
        <!-- Ad Script Goes Here -->
        <script type="text/javascript">atOptions = { 'key' : '84c9a4eabdeffe242051226bdf854fd8', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };</script>
        <script type="text/javascript" src="//www.highperformanceformat.com/84c9a4eabdeffe242051226bdf854fd8/invoke.js"></script>
    </div>

    <!-- Firebase SDK and App Logic -->
    <script type="module">
      // Firebase Imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import { getDatabase, ref, onValue, set, get, runTransaction, serverTimestamp, update, push, query, orderByChild, equalTo, limitToLast } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

      // Firebase Config (REPLACE WITH YOURS!)
      // --- IMPORTANT: Replace with your actual Firebase configuration ---
      // --- Ø¶Ø±ÙˆØ±ÛŒ: Ø§Ù¾Ù†Û’ Ø§ØµÙ„ Firebase Ú©Ù†ÙÛŒÚ¯Ø±ÛŒØ´Ù† Ø³Û’ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº ---
      const firebaseConfig = {
        apiKey: "AIzaSyAHJC00C6CcbVn4cp2Gu-WC6CzhbofKNnE", // Ø¢Ù¾ Ú©ÛŒ API Key ÛŒÛØ§Úº ÚˆØ§Ù„ÛŒÚº
        authDomain: "trading-94d96.firebaseapp.com",     // Ø¢Ù¾ Ú©Ø§ Auth Domain ÛŒÛØ§Úº ÚˆØ§Ù„ÛŒÚº
        databaseURL: "https://trading-94d96-default-rtdb.firebaseio.com", // Ø¢Ù¾ Ú©Ø§ Database URL ÛŒÛØ§Úº ÚˆØ§Ù„ÛŒÚº
        projectId: "trading-94d96",               // Ø¢Ù¾ Ú©Ø§ Project ID ÛŒÛØ§Úº ÚˆØ§Ù„ÛŒÚº
        storageBucket: "trading-94d96.appspot.com", // Ø¢Ù¾ Ú©Ø§ Storage Bucket ÛŒÛØ§Úº ÚˆØ§Ù„ÛŒÚº
        messagingSenderId: "570063192101",        // Ø¢Ù¾ Ú©Ø§ Sender ID ÛŒÛØ§Úº ÚˆØ§Ù„ÛŒÚº
        appId: "1:570063192101:web:99c855fc5b5d1b8c357fcc",           // Ø¢Ù¾ Ú©ÛŒ App ID ÛŒÛØ§Úº ÚˆØ§Ù„ÛŒÚº
        measurementId: "G-CPX5MXDLB0" // Ø§Ø®ØªÛŒØ§Ø±ÛŒ: Measurement ID
      };
      // --- ALSO IMPORTANT: Set up Firebase Database Rules including .indexOn ---
      // --- Database Rules Example:
      // {
      //   "rules": {
      //     "users": {
      //       "$uid": {
      //         ".read": "$uid === auth.uid",
      //         ".write": "$uid === auth.uid",
      //         ".indexOn": ["referrer", "lastCheckinTimestamp", "points"] // Index for lookups/sorting
      //       },
      //        // Allow reading invitedUsers sub-list by referrer (optional, secure with functions if needed)
      //        // ".indexOn": "referrer" // Top-level index for finding referred users
      //     },
      //     "buyOrders": {
      //       ".indexOn": ["userId", "timestamp"], // Index for user history query
      //       ".read": "auth != null", // Allow logged-in users to read (needed for history)
      //       "$orderId": {
      //         // Allow user to write their own order, but maybe not update/delete?
      //         ".write": "auth != null && (!data.exists() || data.child('userId').val() === auth.uid)",
      //         // Allow owner to read their specific order
      //         ".read": "auth != null && data.child('userId').val() === auth.uid"
      //       }
      //       // Add rules for admin access if needed
      //     },
      //     "sellOrders": { ".indexOn": ["userId", "timestamp"], /* similar read/write rules as buyOrders */ },
      //     "withdrawalRequests": { ".indexOn": ["userId", "timestamp"], /* similar read/write rules as buyOrders */ },
      //     "coins": { ".read": true }, // Allow anyone to read coin prices
      //     "news": { ".read": true }, // Allow anyone to read news
      //     "tasks": { ".read": "auth != null" }, // Allow logged-in users to read tasks
      //     // Add more secure rules for admin functions (updating status, prices etc.)
      //     // You might need Cloud Functions for secure point updates, status changes etc.
      //   }
      // }

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      // --- DOM References ---
      const authContainer = document.getElementById('auth-container');
      const mainAppContainer = document.getElementById('main-app');
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const loginErrorDiv = document.getElementById('login-error');
      const signupErrorDiv = document.getElementById('signup-error');
      const signupReferralCodeInput = document.getElementById('signup-referral-code');
      const bodyElement = document.body;
      const pointsDisplay = document.getElementById('points-display');
      const pages = document.querySelectorAll('#main-app .page');
      const navButtons = document.querySelectorAll('#bottom-nav button');
      const buyModal = document.getElementById('buyModal');
      const sellModal = document.getElementById('sellModal');
      const withdrawModal = document.getElementById('withdrawModal');
      const profileModal = document.getElementById('profileModal');
      const inviteListModal = document.getElementById('inviteListModal');
      const inviteListContentDiv = document.getElementById('invite-list-content');
      const buyCoinNameSpan = document.getElementById('buyCoinName');
      const sellCoinNameSpan = document.getElementById('sellCoinName');
      const buyForm = document.getElementById('buyForm');
      const sellForm = document.getElementById('sellForm');
      const withdrawForm = document.getElementById('withdrawForm');
      const withdrawMessageDiv = document.getElementById('withdraw-message');
      const withdrawCurrentPointsSpan = document.getElementById('withdraw-current-points');
      const withdrawMinimumPointsSpan = document.getElementById('withdraw-minimum-points');
      const withdrawButton = document.getElementById('withdraw-button');
      const inviteListButton = document.getElementById('invite-list-button');
      const profileButtonEarn = document.getElementById('profile-button-earn');
      const profileModalUserName = document.getElementById('profile-modal-user-name');
      const profileModalUserEmail = document.getElementById('profile-modal-user-email');
      const profileModalUserPoints = document.getElementById('profile-modal-user-points');
      const dealerAddressInfoDiv = document.getElementById('dealerAddressInfo');
      const newsContainer = document.getElementById('news-container');
      const taskListUl = document.getElementById('task-list');
      const dynamicTasksLoadingMsg = document.getElementById('dynamic-tasks-loading');
      const referralLinkInput = document.getElementById('referral-link-input');
      const copyLinkButton = document.getElementById('copy-link-button');
      const dailyCheckinButton = document.getElementById('daily-checkin-button');
      const historyListUl = document.getElementById('history-list');
      const historyLoadingMsg = document.getElementById('history-loading-msg');

      // --- State Variables ---
      let userPoints = 0;
      let currentUserId = null;
      let currentUserName = null;
      let currentUserEmail = null;
      let lastCheckinTimestamp = null;
      const MIN_WITHDRAWAL_POINTS = 10000;
      const REFERRAL_POINTS = 200; // Note: Actual point granting relies on secure logic (e.g., Cloud Functions)
      const DAILY_CHECKIN_POINTS = 10;
      const BASE_URL = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1); // Dynamic base URL
      let capturedReferrerId = null;
      const dealerAddresses = {
          "Sidra Chain": "0x023621E749dBD87b9EA06fd11d6893C4761DaBF7", // Example, replace if needed
          "USDT (TRC20)": "TKheWvzZB8WekfdQwUbp8VW4u6nfUmNedi" // Example, replace if needed
      };
      let listeners = {}; // To detach listeners on logout
      const TASK_TIMER_DURATION = 30; // seconds for dynamic tasks
      let completedTaskKeys = new Set();
      let u = undefined; // Shorthand for undefined checks

       // --- Utility Functions ---
       function setAuthError(type, msg) {
           const errorDiv = type === 'login' ? loginErrorDiv : signupErrorDiv;
           if (errorDiv) errorDiv.textContent = msg;
       }
       function clearAuthErrors() {
           if (loginErrorDiv) loginErrorDiv.textContent = '';
           if (signupErrorDiv) signupErrorDiv.textContent = '';
       }
       function showLoginForm() {
           if (loginForm) loginForm.style.display = 'block';
           if (signupForm) signupForm.style.display = 'none';
           clearAuthErrors();
           checkReferralAndPrefill(); // Check again when switching forms
       }
       window.showLoginForm = showLoginForm; // Make globally accessible

       function showSignupForm() {
           if (loginForm) loginForm.style.display = 'none';
           if (signupForm) signupForm.style.display = 'block';
           clearAuthErrors();
           checkReferralAndPrefill(); // Check again when switching forms
       }
       window.showSignupForm = showSignupForm; // Make globally accessible

       function isSameDay(timestamp1, timestamp2) {
            if (!timestamp1 || !timestamp2) return false;
            // Use UTC dates to avoid timezone issues affecting 'day' comparison
            const date1 = new Date(timestamp1);
            const date2 = new Date(timestamp2);
            return date1.getUTCFullYear() === date2.getUTCFullYear() &&
                   date1.getUTCMonth() === date2.getUTCMonth() &&
                   date1.getUTCDate() === date2.getUTCDate();
       }

       // --- Capture Referrer & Prefill ---
       function captureReferrer() {
           const params = new URLSearchParams(window.location.search);
           const refCode = params.get('ref');
           if (refCode) {
               console.log("Referrer code captured from URL:", refCode);
               capturedReferrerId = refCode;
               // Clean the URL - remove the ref parameter
               if (history.replaceState) {
                   const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                   history.replaceState({ path: cleanUrl }, '', cleanUrl);
               }
           }
       }
       captureReferrer(); // Capture on page load

       function checkReferralAndPrefill() {
           if (capturedReferrerId && signupReferralCodeInput && signupForm.style.display !== 'none') {
               signupReferralCodeInput.value = capturedReferrerId;
               signupReferralCodeInput.readOnly = true;
               // Style applied via CSS rule `input[readonly]`
           } else if (signupReferralCodeInput) {
               // Ensure it's editable if no captured ID or signup form is hidden
               signupReferralCodeInput.readOnly = false;
               // Don't clear the value if the user manually entered something
           }
       }

       // --- Firebase Auth Listener ---
       onAuthStateChanged(auth, (user) => {
           // Detach previous listeners to prevent memory leaks on re-login
           Object.values(listeners).forEach(listener => listener.detach());
           listeners = {};

           if (user) {
               // User is signed in
               currentUserId = user.uid;
               currentUserEmail = user.email;
               console.log("User logged in:", currentUserEmail, currentUserId);
               lastCheckinTimestamp = null; // Reset before fetching
               completedTaskKeys = new Set(); // Reset before fetching

               const userRef = ref(db, `users/${currentUserId}`);
               get(userRef).then((snapshot) => {
                   if (snapshot.exists()) {
                       const userData = snapshot.val();
                       currentUserName = userData.name || "User";
                       userPoints = typeof userData.points === 'number' ? userData.points : 0;
                       lastCheckinTimestamp = userData.lastCheckinTimestamp || null;
                       // Load completed tasks
                       if (userData.completedTasks) {
                           Object.keys(userData.completedTasks).forEach(key => {
                               if (userData.completedTasks[key] === true) {
                                   completedTaskKeys.add(key);
                               }
                           });
                       }
                       console.log(`User data loaded: ${currentUserName}, Points: ${userPoints}, Last Checkin: ${lastCheckinTimestamp}`);
                   } else {
                       // First login scenario after account creation, create basic user data
                       console.log("First login or data missing, creating/updating data...");
                       currentUserName = "User"; // Default name, maybe get from auth profile later if needed
                       userPoints = 0;
                       set(userRef, {
                           name: currentUserName, // Consider fetching name from auth profile if available
                           email: currentUserEmail,
                           points: 0,
                           completedTasks: {},
                           joinedAt: serverTimestamp(),
                           lastCheckinTimestamp: null // Explicitly null
                       }).catch(err => console.error("Error setting initial user data:", err));
                   }
                   // Update UI elements that depend on user data
                   if (pointsDisplay) pointsDisplay.textContent = userPoints.toLocaleString(); // Format points
                   if (withdrawButton) withdrawButton.disabled = userPoints < MIN_WITHDRAWAL_POINTS;
                   updateReferralLink();
                   updateDailyCheckinButtonState();
                   // Refresh dynamic tasks display now that completed keys are known
                   const tasksListener = listeners['tasks'];
                   if (tasksListener) {
                        const taskSnapshot = tasksListener.getSnapshot();
                        if (taskSnapshot) displayDynamicTasks(taskSnapshot);
                   }

               }).catch((error) => {
                   console.error("Error fetching user data:", error);
                   currentUserName = "Error";
                   userPoints = 0;
                   // Reset relevant UI to default/error state
                   if (pointsDisplay) pointsDisplay.textContent = '0';
                   if (withdrawButton) withdrawButton.disabled = true;
                   if (referralLinkInput) referralLinkInput.value = "Error loading link";
                   if (dailyCheckinButton) dailyCheckinButton.disabled = true;
               });

               // UI Transition: Hide Auth, Show App
               if (authContainer) authContainer.style.display = 'none';
               if (mainAppContainer) mainAppContainer.style.display = 'block';
               if (bodyElement) bodyElement.classList.add('logged-in');

               // Show default page (Trading) and set active button
               showPage('page-trading', document.getElementById('btn-trading'));

               // Set up Realtime Listeners for app data
               listenToData('coins', displayCoinPrices);
               listenToData('news', displayNews);
               listenToData('tasks', displayDynamicTasks);
               // Listen to specific user data changes
               listenToData(`users/${currentUserId}/points`, displayUserPoints);
               listenToData(`users/${currentUserId}/completedTasks`, refreshTaskCompletionStatus);
               listenToData(`users/${currentUserId}/lastCheckinTimestamp`, (snapshot) => {
                    lastCheckinTimestamp = snapshot.exists() ? snapshot.val() : null;
                    updateDailyCheckinButtonState();
               });

           } else {
               // User is signed out
               currentUserId = null;
               currentUserName = null;
               currentUserEmail = null;
               userPoints = 0;
               completedTaskKeys = new Set();
               lastCheckinTimestamp = null;
               console.log("User logged out");

               // UI Transition: Show Auth, Hide App
               if (authContainer) authContainer.style.display = 'block';
               if (mainAppContainer) mainAppContainer.style.display = 'none';
               if (bodyElement) bodyElement.classList.remove('logged-in');

               // Reset UI to logged-out state
               showLoginForm(); // Show login form by default
               checkReferralAndPrefill(); // Ensure referral field is handled correctly on logout/login screen
               if (pointsDisplay) pointsDisplay.textContent = '0';
               if (newsContainer) newsContainer.innerHTML = '<p class="text-center mt-2">Please log in to see news.</p>';
               // Clear dynamic tasks
               const dynamicTaskItems = taskListUl?.querySelectorAll('.dynamic-task-item');
               dynamicTaskItems?.forEach(task => task.remove());
               if (dynamicTasksLoadingMsg) dynamicTasksLoadingMsg.textContent = 'Log in to see tasks.';
               // Reset buttons and inputs
               if (withdrawButton) withdrawButton.disabled = true;
               if (referralLinkInput) referralLinkInput.value = 'Log in to get your referral link.';
               if (dailyCheckinButton) {
                   dailyCheckinButton.disabled = true;
                   dailyCheckinButton.textContent = 'Check-in Now';
                   dailyCheckinButton.classList.remove('checked-in');
               }
               // Reset coin prices
               const priceSpans = document.querySelectorAll('.coin-price-usd, .coin-price-pkr');
               priceSpans.forEach(span => span.textContent = '...');
               // Clear history list
                if (historyListUl) historyListUl.innerHTML = '';
                if (historyLoadingMsg) {
                    historyLoadingMsg.textContent = 'Log in to view transaction history.';
                    historyLoadingMsg.style.display = 'block';
                }
           }
       });

       // --- Generic Listener Setup ---
       function listenToData(path, callback) {
           const dataRef = ref(db, path);
           let currentSnapshot = null; // Cache the snapshot locally within this closure

           const detachFn = onValue(dataRef, (snapshot) => {
               currentSnapshot = snapshot; // Update cache on new data
               callback(snapshot); // Call the provided callback with the snapshot
           }, (error) => {
               console.error(`Firebase listener error on path "${path}":`, error);
               currentSnapshot = null; // Clear cache on error
               // Call the callback with null snapshot and the error for handling
               callback(null, error);
           });

           // Store the detach function and a getter for the current snapshot
           listeners[path] = {
               detach: detachFn,
               getSnapshot: () => currentSnapshot // Allows retrieving the last known state
           };
       }

       // --- Display Functions ---
        function displayCoinPrices(snapshot, error = null) {
            const usdSidra = document.getElementById('price-sidra-usd');
            const pkrSidra = document.getElementById('price-sidra-pkr');
            const usdUsdt = document.getElementById('price-usdt_trc20-usd');
            const pkrUsdt = document.getElementById('price-usdt_trc20-pkr');

            // Helper to update price elements safely
            const updatePrice = (usdEl, pkrEl, usdPrice, pkrPrice) => {
                if (usdEl) usdEl.textContent = usdPrice !== u && usdPrice !== null ? `$${Number(usdPrice).toFixed(2)}` : '$ --'; // Use '--' for N/A
                if (pkrEl) pkrEl.textContent = pkrPrice !== u && pkrPrice !== null ? `PKR ${Number(pkrPrice).toFixed(2)}` : 'PKR --';
            };

            if (error) {
                console.error("Error fetching coin prices:", error);
                // Show N/A on error
                updatePrice(usdSidra, pkrSidra, u, u);
                updatePrice(usdUsdt, pkrUsdt, u, u);
                return;
            }

            if (snapshot && snapshot.exists()) {
                const prices = snapshot.val();
                // Use optional chaining for safer access
                updatePrice(usdSidra, pkrSidra, prices?.sidra?.price, prices?.sidra?.price_pkr);
                updatePrice(usdUsdt, pkrUsdt, prices?.usdt_trc20?.price, prices?.usdt_trc20?.price_pkr);
            } else {
                // No data found, show N/A
                console.log("No coin price data found in database.");
                updatePrice(usdSidra, pkrSidra, u, u);
                updatePrice(usdUsdt, pkrUsdt, u, u);
            }
        }

        function displayNews(snapshot, error = null) {
            if (!newsContainer) return;
            newsContainer.innerHTML = ''; // Clear previous news

            if (error) {
                console.error("Error fetching news:", error);
                newsContainer.innerHTML = '<p class="text-center mt-2" style="color: var(--danger-color);">Could not load news.</p>';
                return;
            }

            if (snapshot && snapshot.exists()) {
                const newsData = snapshot.val();
                // Filter out any non-object entries and sort by timestamp (newest first)
                const newsItems = Object.entries(newsData)
                    .filter(([key, item]) => item && typeof item === 'object')
                    .map(([key, item]) => ({ ...item, id: key })) // Add ID if needed later
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                if (newsItems.length === 0) {
                     newsContainer.innerHTML = '<p class="text-center mt-2">No news available right now.</p>';
                     return;
                }

                newsItems.forEach(item => {
                    const newsDiv = document.createElement('div');
                    newsDiv.className = 'news-item';

                    // Add placeholder image if imageUrl is missing
                    const imageUrl = item.imageUrl || `https://via.placeholder.com/350x180/e2e8f0/718096?text=News`;

                    // Create button HTML conditionally
                    let buttonHtml = '<a href="#" class="join-button disabled" style="pointer-events:none; opacity:0.7;">Link Unavailable</a>';
                    if (item.joinLink) {
                        buttonHtml = `<a href="${item.joinLink}" target="_blank" rel="noopener noreferrer" class="join-button">Learn More</a>`;
                    }

                    newsDiv.innerHTML = `
                        <img src="${imageUrl}" alt="${item.title || 'News Image'}" class="news-image" onerror="this.onerror=null; this.src='https://via.placeholder.com/350x180/fef2f2/b91c1c?text=Image+Error'; this.alt='Image Load Error'">
                        <div class="news-content">
                            <h3 class="news-title">${item.title || 'Untitled News'}</h3>
                            <p class="news-text">${item.text || 'No description available.'}</p>
                            ${buttonHtml}
                        </div>
                    `;
                    newsContainer.appendChild(newsDiv);
                });
            } else {
                newsContainer.innerHTML = '<p class="text-center mt-2">No news available right now.</p>';
            }
        }

        function refreshTaskCompletionStatus(snapshot, error = null) {
             completedTaskKeys = new Set(); // Reset the set from the latest DB state
             if (error) {
                 console.error("Error fetching completed tasks status:", error);
                 // Avoid refreshing display if status fetch failed, could lead to incorrect state
                 return;
             }
             if (snapshot && snapshot.exists()) {
                 const completedData = snapshot.val();
                 Object.keys(completedData).forEach(key => {
                     if (completedData[key] === true) {
                         completedTaskKeys.add(key);
                     }
                 });
             }
             // Now that completedTaskKeys is updated, refresh the dynamic task list display
             const tasksListener = listeners['tasks'];
             if (tasksListener) {
                 const taskSnapshot = tasksListener.getSnapshot(); // Get cached snapshot
                 if (taskSnapshot) { // Only call if snapshot exists
                     displayDynamicTasks(taskSnapshot);
                 } else {
                     // Tasks haven't loaded yet, displayDynamicTasks will handle it when listener fires.
                     console.log("Task snapshot not yet available for refresh after completion status update.");
                 }
             }
        }

        function displayDynamicTasks(snapshot, error = null) {
            // Remove only existing *dynamic* tasks first
            const existingTasks = taskListUl?.querySelectorAll('.dynamic-task-item');
            existingTasks?.forEach(task => task.remove());

            if (!taskListUl || !dynamicTasksLoadingMsg) return; // Ensure elements exist

            if (error) {
                console.error("Error fetching dynamic tasks:", error);
                dynamicTasksLoadingMsg.textContent = 'Error loading tasks.';
                dynamicTasksLoadingMsg.style.display = 'block';
                return;
            }

            if (snapshot && snapshot.exists()) {
                const tasksData = snapshot.val();
                // Filter for active tasks and sort (e.g., by timestamp or order field if added)
                const activeTasks = Object.entries(tasksData)
                    .filter(([key, task]) => task && typeof task === 'object' && task.status === 'active' && task.description && task.points !== u)
                    .map(([key, task]) => ({ ...task, id: key }))
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Example sort

                let hasActiveTasks = false;

                if (activeTasks.length > 0) {
                    hasActiveTasks = true;
                    activeTasks.forEach(task => {
                        const listItem = document.createElement('li');
                        listItem.className = 'task-item dynamic-task-item';
                        listItem.dataset.taskId = task.id;
                        listItem.dataset.points = task.points || 0;
                        listItem.dataset.link = task.link || '';

                        const isCompleted = completedTaskKeys.has(task.id);
                        let actionHtml = '';

                        if (isCompleted) {
                            actionHtml = '<span class="completed-message">Completed</span>';
                        } else {
                            // Structure for Visit -> Timer -> Claim
                            // Ensure unique IDs for elements if needed, though querySelector on parent works
                            actionHtml = `
                                <button class="task-button visit-button" onclick="startTaskTimer('${task.id}')">Visit Task</button>
                                <div class="timer-claim-section" style="display:none;">
                                    <span class="timer"></span>
                                    <button class="task-button claim-button" style="display:none;"></button>
                                </div>
                            `;
                        }

                        listItem.innerHTML = `
                            <div class="task-header">
                                <span class="task-desc">${task.description}</span>
                                <span class="task-points">+${task.points || 0} Pts</span>
                            </div>
                            <div class="task-actions">
                                ${actionHtml}
                            </div>
                        `;
                        taskListUl.appendChild(listItem);
                    });
                }

                // Update loading/no tasks message based on whether active tasks were found
                dynamicTasksLoadingMsg.style.display = hasActiveTasks ? 'none' : 'block';
                dynamicTasksLoadingMsg.textContent = hasActiveTasks ? '' : 'No other tasks available right now.';

            } else {
                dynamicTasksLoadingMsg.textContent = 'No other tasks available right now.';
                dynamicTasksLoadingMsg.style.display = 'block';
            }
        }

        function displayUserPoints(snapshot, error = null) {
             if (error) {
                 console.error("Error fetching user points:", error);
                 // Optionally show 'N/A' or keep last known value, depends on desired UX
                 return;
             }
             if (snapshot && snapshot.exists()) {
                 const points = snapshot.val();
                 userPoints = typeof points === 'number' ? points : 0;
             } else {
                 // Path might not exist if user doc wasn't created properly initially, treat as 0
                 userPoints = 0;
                 console.warn(`User points node (users/${currentUserId}/points) does not exist.`);
             }

             // Update relevant UI elements with formatted points
             const formattedPoints = userPoints.toLocaleString(); // Add commas
             if (pointsDisplay) pointsDisplay.textContent = formattedPoints;
             if (withdrawButton) withdrawButton.disabled = userPoints < MIN_WITHDRAWAL_POINTS;

             // Update modals only if they are currently visible
             if (profileModal && profileModal.classList.contains('show')) {
                 if (profileModalUserPoints) profileModalUserPoints.textContent = formattedPoints;
             }
             if (withdrawModal && withdrawModal.classList.contains('show')) {
                 if (withdrawCurrentPointsSpan) withdrawCurrentPointsSpan.textContent = formattedPoints;
                 const amountInput = document.getElementById('withdraw-amount');
                 if (amountInput) {
                     amountInput.max = userPoints; // Update max withdrawable amount
                     amountInput.placeholder = `Min ${MIN_WITHDRAWAL_POINTS.toLocaleString()}, Max ${formattedPoints}`;
                 }
             }
        }

       // --- Referral & Check-in UI ---
       function updateReferralLink() {
           if (referralLinkInput) {
               if (currentUserId) {
                   referralLinkInput.value = `${BASE_URL}?ref=${currentUserId}`;
               } else {
                   referralLinkInput.value = "Log in to get your referral link.";
               }
           }
       }

       function copyReferralLink() {
           if (!navigator.clipboard) {
               alert("Clipboard access is not available in this browser or context. Please copy the link manually.");
               referralLinkInput.select(); // Select the text for easier manual copying
               return;
           }
           const linkToCopy = referralLinkInput.value;
           if (linkToCopy && linkToCopy.includes('?ref=')) { // Basic check if link looks valid
               navigator.clipboard.writeText(linkToCopy).then(() => {
                   if (copyLinkButton) {
                       const originalText = copyLinkButton.textContent;
                       copyLinkButton.textContent = 'Link Copied!';
                       copyLinkButton.style.backgroundColor = 'var(--success-color)'; // Feedback color
                       setTimeout(() => {
                           copyLinkButton.textContent = originalText;
                           copyLinkButton.style.backgroundColor = ''; // Reset color
                       }, 2500); // Reset after 2.5 seconds
                   }
               }).catch(err => {
                   console.error('Failed to copy referral link: ', err);
                   alert("Could not copy the link automatically. Please try again or copy manually.");
               });
           } else {
               alert("Referral link is not available yet.");
           }
       }
       window.copyReferralLink = copyReferralLink;

       function updateDailyCheckinButtonState() {
           if (!dailyCheckinButton) return;
           const now = Date.now();
           // Use the isSameDay check which now considers UTC date parts
           if (lastCheckinTimestamp && isSameDay(lastCheckinTimestamp, now)) {
               dailyCheckinButton.disabled = true;
               dailyCheckinButton.textContent = 'Checked in Today';
               dailyCheckinButton.classList.add('checked-in'); // Can use this class for styling
               // Optional: Change background or style for checked-in state
               // dailyCheckinButton.style.backgroundColor = 'var(--success-color)';
               // dailyCheckinButton.style.opacity = '0.8';
           } else {
               dailyCheckinButton.disabled = !currentUserId; // Enable only if logged in
               dailyCheckinButton.textContent = 'Check-in Now';
               dailyCheckinButton.classList.remove('checked-in');
               // Reset styles if changed above
               // dailyCheckinButton.style.backgroundColor = '';
               // dailyCheckinButton.style.opacity = '1';
           }
       }

       async function handleDailyCheckin() {
           if (!currentUserId) {
               alert("Please log in to check in.");
               return;
           }
           const now = Date.now();
           if (lastCheckinTimestamp && isSameDay(lastCheckinTimestamp, now)) {
               alert("You have already checked in today.");
               return;
           }

           if (dailyCheckinButton) {
               dailyCheckinButton.disabled = true;
               dailyCheckinButton.textContent = 'Checking in...';
           }

           const userRef = ref(db, `users/${currentUserId}`);
           const checkinTimestampValue = serverTimestamp(); // Use server timestamp for accuracy

           try {
               // Update points and timestamp in one update operation for better atomicity
               await update(userRef, {
                   points: runTransaction(ref(db, `users/${currentUserId}/points`), (currentPoints) => {
                        // Check if points node exists, handle potential null value
                       return (currentPoints || 0) + DAILY_CHECKIN_POINTS;
                   }), // This transaction runs within the update
                   lastCheckinTimestamp: checkinTimestampValue
               });

               // Listener for `lastCheckinTimestamp` will automatically update the button state.
               // Listener for `points` will automatically update the points display.
               // We can update local state for immediate optimistic UI update if needed,
               // but listeners should catch up quickly.
               // lastCheckinTimestamp = Date.now(); // Optimistic client time
               // userPoints += DAILY_CHECKIN_POINTS;
               // if (pointsDisplay) pointsDisplay.textContent = userPoints.toLocaleString();
               // updateDailyCheckinButtonState();

               alert(`Checked in successfully! You earned ${DAILY_CHECKIN_POINTS} points.`);

           } catch (error) {
                console.error("Error during daily check-in update:", error);
                alert("An error occurred during check-in. Please try again.");
                // Re-enable button based on the potentially unchanged lastCheckinTimestamp
                updateDailyCheckinButtonState(); // Will re-evaluate based on DB state if listeners updated
                // Manually re-enable if state didn't change:
                // if (dailyCheckinButton) dailyCheckinButton.disabled = !currentUserId;
           } finally {
                // No need to reset text here if listeners handle it.
                // If not relying on listeners for text change:
                // updateDailyCheckinButtonState();
           }
       }
       window.handleDailyCheckin = handleDailyCheckin;

       // --- Invite List Modal ---
        async function openInviteListModal() {
            if (!currentUserId) {
                alert("Please log in to view your invites.");
                return;
            }
            if (!inviteListModal || !inviteListContentDiv) return;

            inviteListContentDiv.innerHTML = '<p class="no-invites">Loading invite list...</p>';
            inviteListModal.classList.add('show');

            // Reference to the list of users invited *by* the current user
            const invitedUsersRef = ref(db, `users/${currentUserId}/invitedUsers`);

            try {
                const snapshot = await get(invitedUsersRef);
                inviteListContentDiv.innerHTML = ''; // Clear loading message

                if (snapshot.exists()) {
                    const invitedData = snapshot.val();
                    // Convert object to array and sort by join date (newest first)
                    const invitedList = Object.entries(invitedData)
                        .map(([uid, info]) => ({ ...info, uid })) // Add uid to each object
                        .sort((a, b) => (b.joinedAt || 0) - (a.joinedAt || 0));

                    if (invitedList.length === 0) {
                        inviteListContentDiv.innerHTML = '<p class="no-invites">You haven\'t invited anyone yet.</p>';
                        return;
                    }

                    invitedList.forEach(inviteInfo => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'invite-list-item';

                        const name = inviteInfo.name || 'N/A';
                        const email = inviteInfo.email || 'N/A';
                        // Format date nicely, handle potential missing timestamp
                        let joinDate = 'N/A';
                        if (inviteInfo.joinedAt) {
                            try {
                                joinDate = new Date(inviteInfo.joinedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                            } catch (e) { console.warn("Could not format invite date", e); }
                        }


                        itemDiv.innerHTML = `
                            <span>${name} (${email})</span>
                            <span>Joined: ${joinDate}</span>
                        `;
                        inviteListContentDiv.appendChild(itemDiv);
                    });

                } else {
                    inviteListContentDiv.innerHTML = '<p class="no-invites">You haven\'t invited anyone yet.</p>';
                }
            } catch (error) {
                console.error("Error fetching invited users list:", error);
                inviteListContentDiv.innerHTML = '<p class="no-invites" style="color: var(--danger-color);">Could not load invite list. Please try again.</p>';
            }
        }
        window.openInviteListModal = openInviteListModal;


       // --- Event Listeners ---
       // Signup Form
       if (signupForm) {
           signupForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               clearAuthErrors();
               const nameInput = document.getElementById('signup-name');
               const emailInput = document.getElementById('signup-email');
               const passwordInput = document.getElementById('signup-password');
               const confirmPasswordInput = document.getElementById('signup-confirm-password');

               const name = nameInput?.value.trim();
               const email = emailInput?.value.trim();
               const password = passwordInput?.value;
               const confirmPassword = confirmPasswordInput?.value;
               const referralCode = signupReferralCodeInput?.value.trim(); // Could be prefilled or entered

               // Basic Validations
               if (!name) { setAuthError('signup', 'Please enter your full name.'); return; }
               if (!email) { setAuthError('signup', 'Please enter your email address.'); return; }
               if (!password) { setAuthError('signup', 'Please create a password.'); return; }
               if (password.length < 6) { setAuthError('signup', 'Password must be at least 6 characters long.'); return; }
               if (password !== confirmPassword) { setAuthError('signup', 'Passwords do not match.'); return; }

               const signupButton = signupForm.querySelector('button[type="submit"]');
               if (signupButton) {
                   signupButton.disabled = true;
                   signupButton.textContent = 'Creating Account...';
               }

               try {
                   const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                   const user = userCredential.user;
                   console.log("User account created:", user.uid);

                   // Prepare user data to save in Realtime Database
                   const userData = {
                       name: name,
                       email: email,
                       points: 0,
                       completedTasks: {},
                       joinedAt: serverTimestamp(),
                       lastCheckinTimestamp: null
                   };

                   // Determine the actual referrer (URL param > manual input)
                   let actualReferrerId = null;
                   if (capturedReferrerId && capturedReferrerId !== user.uid) { // Check prefilled ID first
                       actualReferrerId = capturedReferrerId;
                   } else if (referralCode && referralCode !== user.uid) { // Check manually entered code if no prefill
                       actualReferrerId = referralCode;
                   }

                   if (actualReferrerId) {
                        // Validate if the referrer ID actually exists (optional but good practice)
                        const referrerCheckRef = ref(db, `users/${actualReferrerId}`);
                        const referrerSnapshot = await get(referrerCheckRef);
                        if (!referrerSnapshot.exists()) {
                            console.warn(`Referrer ID ${actualReferrerId} does not exist. Not recording referral.`);
                            actualReferrerId = null; // Nullify invalid referrer
                        } else {
                            console.log(`User ${user.uid} was referred by ${actualReferrerId}.`);
                            userData.referrer = actualReferrerId; // Add referrer ID to the new user's data

                            // Add this new user to the referrer's invitedUsers list (best effort)
                            const referrerInvitesRef = ref(db, `users/${actualReferrerId}/invitedUsers/${user.uid}`);
                            set(referrerInvitesRef, {
                                email: email,
                                name: name, // Store name and email for the invite list modal
                                joinedAt: serverTimestamp()
                            }).catch(err => console.error("Error updating referrer's invitedUsers list:", err));

                            // IMPORTANT: Granting referral points should ideally be handled securely.
                            // A Cloud Function triggered on user creation checking the 'referrer' field
                            // is the recommended approach to prevent manipulation.
                            console.log(`ACTION NEEDED: Securely award ${REFERRAL_POINTS} points to referrer ${actualReferrerId} (e.g., via Cloud Function).`);
                        }
                   }

                   // Save user data to database under their UID
                   await set(ref(db, `users/${user.uid}`), userData);
                   console.log("User data saved to Realtime Database.");

                   // Reset form and state after successful signup
                   signupForm.reset();
                   if (signupReferralCodeInput) {
                       signupReferralCodeInput.readOnly = false; // Make editable again for next potential signup
                   }
                   capturedReferrerId = null; // Clear captured ID after it's been used/checked
                   // The onAuthStateChanged listener will automatically handle redirecting to the main app.

               } catch (error) {
                   console.error("Signup Error:", error.code, error.message);
                   let errorMessage = "Signup failed. Please try again.";
                   // Provide more specific error messages based on Firebase error codes
                   if (error.code === 'auth/email-already-in-use') {
                       errorMessage = "This email address is already registered. Try logging in.";
                   } else if (error.code === 'auth/weak-password') {
                       errorMessage = "Password is too weak. Please use at least 6 characters.";
                   } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Please enter a valid email address.";
                   }
                   setAuthError('signup', errorMessage);
               } finally {
                   // Re-enable the signup button regardless of success or failure
                   if (signupButton) {
                       signupButton.disabled = false;
                       signupButton.textContent = 'Create Account';
                   }
               }
           });
       }

       // Login Form
       if (loginForm) {
           loginForm.addEventListener('submit', (e) => {
               e.preventDefault();
               clearAuthErrors();
               const emailInput = document.getElementById('login-email');
               const passwordInput = document.getElementById('login-password');
               const email = emailInput?.value.trim();
               const password = passwordInput?.value;

               if (!email || !password) {
                   setAuthError('login', 'Please enter both email and password.');
                   return;
               }

               const loginButton = loginForm.querySelector('button[type="submit"]');
               if (loginButton) {
                   loginButton.disabled = true;
                   loginButton.textContent = 'Logging In...';
               }

               signInWithEmailAndPassword(auth, email, password)
                   .then((userCredential) => {
                       // Signed in successfully
                       console.log("User logged in successfully:", userCredential.user.email);
                       // The onAuthStateChanged listener handles showing the main app.
                       // No need to reset button here, as the view will change.
                       loginForm.reset(); // Clear form fields after successful login attempt start
                   })
                   .catch((error) => {
                       console.error("Login Error:", error.code, error.message);
                       let errorMessage = 'Login failed. Please try again.';
                        // Handle common login errors
                       if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                           errorMessage = 'Incorrect email or password.';
                       } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'Please enter a valid email address.';
                       } else if (error.code === 'auth/too-many-requests') {
                           errorMessage = 'Access temporarily disabled due to too many attempts. Please try again later.';
                       }
                       setAuthError('login', errorMessage);
                       // Re-enable the login button only on failure
                       if (loginButton) {
                           loginButton.disabled = false;
                           loginButton.textContent = 'Login Securely';
                       }
                   });
           });
       }

        // --- Logout Function ---
        function handleLogout() {
             signOut(auth).then(() => {
                 console.log("User signed out successfully.");
                 closeModal('profileModal'); // Close profile modal if open
                 // The onAuthStateChanged listener handles all UI changes and listener detachment.
             }).catch((error) => {
                 console.error("Sign out error:", error);
                 alert("Error signing out. Please try again.");
             });
         }
         window.handleLogout = handleLogout; // Make accessible globally (e.g., for button onclick)

        // --- App Navigation Logic ---
        function showPage(pageId, clickedButton) {
            // Hide all pages first
            pages.forEach(page => page.classList.remove('active'));
            // Deactivate all nav buttons
            navButtons.forEach(button => button.classList.remove('active'));

            const pageToShow = document.getElementById(pageId);

            if (pageToShow) {
                pageToShow.classList.add('active'); // Show the target page
                // Perform actions specific to the page being shown
                if (pageId === 'page-earn') {
                    // Refresh dynamic data potentially needed on Earn page
                    updateReferralLink();
                    updateDailyCheckinButtonState();
                    if (withdrawButton) withdrawButton.disabled = userPoints < MIN_WITHDRAWAL_POINTS;
                    // Trigger refresh of dynamic tasks in case they weren't loaded or completion status changed
                    const tasksListener = listeners['tasks'];
                     if (tasksListener) {
                         const taskSnapshot = tasksListener.getSnapshot();
                         if (taskSnapshot) displayDynamicTasks(taskSnapshot);
                     }
                } else if (pageId === 'page-history') {
                    // Load or refresh history data when the history page becomes active
                    loadHistoryData();
                }
                // Add more 'else if' blocks for other pages if specific actions are needed on load
            } else {
                // Fallback to the default page (Trading) if the requested page ID is invalid
                console.warn(`Page with ID "${pageId}" not found. Showing default 'page-trading'.`);
                document.getElementById('page-trading')?.classList.add('active');
                clickedButton = document.getElementById('btn-trading'); // Target default button for activation
            }

            // Activate the corresponding navigation button
            if (clickedButton) {
                clickedButton.classList.add('active');
            } else {
                // If somehow clickedButton wasn't passed, try to find based on pageId
                const correspondingButton = document.getElementById(`btn-${pageId.replace('page-', '')}`);
                correspondingButton?.classList.add('active');
            }


            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top smoothly when changing pages
        }
        window.showPage = showPage; // Make globally accessible

       // --- History Loading and Display ---
        async function loadHistoryData() {
            // Guard clauses
            if (!currentUserId) {
                console.log("Cannot load history: User not logged in.");
                 if (historyListUl) historyListUl.innerHTML = ''; // Clear list
                 if (historyLoadingMsg) {
                    historyLoadingMsg.textContent = 'Log in to view history.';
                    historyLoadingMsg.style.display = 'block';
                 }
                return;
            }
             if (!historyListUl || !historyLoadingMsg) {
                console.error("Cannot load history: History list or message element not found.");
                 return;
             }


            historyLoadingMsg.textContent = 'Loading history...';
            historyLoadingMsg.style.display = 'block';
            historyListUl.innerHTML = ''; // Clear previous history items

            try {
                // --- IMPORTANT: Ensure Firebase Rules allow these queries and have .indexOn rules ---
                // Example Rule Snippet for one type:
                // "buyOrders": { ".indexOn": ["userId", "timestamp"] }
                const baseQueryConstraints = [
                    orderByChild('userId'), // Requires ".indexOn": "userId"
                    equalTo(currentUserId),
                    limitToLast(50) // Limit results per type for performance
                ];

                const buyQuery = query(ref(db, 'buyOrders'), ...baseQueryConstraints);
                const sellQuery = query(ref(db, 'sellOrders'), ...baseQueryConstraints);
                const withdrawQuery = query(ref(db, 'withdrawalRequests'), ...baseQueryConstraints);

                // Fetch all data concurrently using Promise.all
                const [buySnap, sellSnap, withdrawSnap] = await Promise.all([
                    get(buyQuery),
                    get(sellQuery),
                    get(withdrawQuery)
                ]);

                let combinedHistory = [];

                // Helper function to process snapshots and add type identifier
                const processSnapshot = (snapshot, type) => {
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const data = childSnapshot.val();
                            // Add key and type for easier processing
                            combinedHistory.push({
                                ...data,
                                id: childSnapshot.key,
                                type: type
                            });
                        });
                    }
                };

                processSnapshot(buySnap, 'Buy');
                processSnapshot(sellSnap, 'Sell');
                processSnapshot(withdrawSnap, 'Withdraw');

                // Sort combined history by timestamp (newest first)
                // Ensure 'timestamp' exists and is a comparable value (Firebase Server Timestamp works)
                combinedHistory.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                // Display the sorted history
                displayHistory(combinedHistory);

            } catch (error) {
                console.error("Error loading transaction history:", error);
                historyLoadingMsg.textContent = 'Failed to load history. Please try again.';
                historyLoadingMsg.style.display = 'block';
                historyListUl.innerHTML = ''; // Clear list on error
            }
        }

        function displayHistory(items) {
             if (!historyListUl || !historyLoadingMsg) return;

             historyListUl.innerHTML = ''; // Clear previous items

             if (!items || items.length === 0) {
                 historyLoadingMsg.textContent = 'You have no transaction history yet.';
                 historyLoadingMsg.style.display = 'block';
             } else {
                 historyLoadingMsg.style.display = 'none'; // Hide loading/empty message

                 items.forEach(item => {
                     const li = document.createElement('li');
                     li.className = 'history-item';

                     // Format date and time safely
                     let dateTime = 'Date N/A';
                     if (item.timestamp) {
                         try {
                            dateTime = new Date(item.timestamp).toLocaleString('en-US', {
                                year: 'numeric', month: 'short', day: 'numeric',
                                hour: 'numeric', minute: '2-digit', hour12: true
                             });
                         } catch (e) { console.warn("Could not format history date", e); }
                     }


                     // Determine status and class (default to pending, case-insensitive)
                     const status = (item.status || 'pending').toLowerCase();
                     const statusClass = `status-${status}`; // e.g., status-pending
                     const statusText = status.toUpperCase();

                     let detailsHtml = '';
                     let typeText = '';

                     // Generate details based on transaction type (using optional chaining ?. for safety)
                     if (item.type === 'Buy') {
                         typeText = `Buy: ${item.coinName || 'N/A'}`;
                         detailsHtml = `
                             <p><strong>Quantity:</strong> <span>${item.quantity || 'N/A'}</span></p>
                             <p><strong>Wallet/Exch:</strong> <span>${item.walletName || 'N/A'}</span></p>
                             <p><strong>Recv Address:</strong> <span>${item.receivingAddress || 'N/A'}</span></p>
                             <p><strong>Pay Method:</strong> <span>${item.paymentMethod || 'N/A'}</span></p>
                             <p><strong>Pay Ref/TID:</strong> <span>${item.transactionId || 'N/A'}</span></p>
                             <p><strong>Sender Name:</strong> <span>${item.senderAccountName || 'N/A'}</span></p>
                             <p><strong>Sender Acct:</strong> <span>${item.senderAccountNumber || 'N/A'}</span></p>
                         `;
                     } else if (item.type === 'Sell') {
                         typeText = `Sell: ${item.coinName || 'N/A'}`;
                         detailsHtml = `
                             <p><strong>Quantity:</strong> <span>${item.quantity || 'N/A'}</span></p>
                             <p><strong>Crypto TX Hash:</strong> <span>${item.cryptoTxHash || 'N/A'}</span></p>
                             <p><strong>Receive Method:</strong> <span>${item.paymentMethod || 'N/A'}</span></p>
                             <p><strong>Receive Acct Name:</strong> <span>${item.receiverAccountName || 'N/A'}</span></p>
                             <p><strong>Receive Acct No:</strong> <span>${item.receiverAccountNumber || 'N/A'}</span></p>
                         `;
                     } else if (item.type === 'Withdraw') {
                         typeText = `Withdraw Points`;
                         detailsHtml = `
                             <p><strong>Points:</strong> <span>${(item.pointsAmount || 0).toLocaleString()}</span></p>
                             <p><strong>Receive Method:</strong> <span>${item.paymentMethod || 'N/A'}</span></p>
                             <p><strong>Receive Acct Name:</strong> <span>${item.receiverAccountName || 'N/A'}</span></p>
                             <p><strong>Receive Acct No:</strong> <span>${item.receiverAccountNumber || 'N/A'}</span></p>
                         `;
                     } else {
                         typeText = `Unknown Type: ${item.type || 'N/A'}`;
                         detailsHtml = `<p>Details not available for this type.</p>`;
                     }

                     // Construct the list item HTML
                     li.innerHTML = `
                         <div class="history-item-header">
                             <span class="history-item-type">${typeText}</span>
                             <span class="history-item-date">${dateTime}</span>
                         </div>
                         <div class="history-item-details">
                             ${detailsHtml}
                         </div>
                         <span class="history-item-status ${statusClass}">${statusText}</span>
                     `;
                     historyListUl.appendChild(li);
                 });
             }
         }


       // --- Task Timer & Claim ---
        // Store active timers to prevent duplicates and allow cleanup
        const activeTaskTimers = {};

        async function startTaskTimer(taskId) {
            if (!currentUserId) return;
            if (completedTaskKeys.has(taskId)) { console.log(`Task ${taskId} already completed.`); return; }
            if (activeTaskTimers[taskId]) { console.log(`Timer already running for task ${taskId}.`); return; }

            const taskElement = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
            if (!taskElement) { console.error(`Task element not found for ID: ${taskId}`); return; }

            const visitButton = taskElement.querySelector('.visit-button');
            const timerSection = taskElement.querySelector('.timer-claim-section');
            const timerSpan = timerSection?.querySelector('.timer');
            const claimButton = timerSection?.querySelector('.claim-button');
            const taskLink = taskElement.dataset.link;
            const taskPoints = parseInt(taskElement.dataset.points || '0');

            if (!timerSection || !timerSpan || !claimButton) {
                console.error(`Timer/Claim elements missing in task element for ID: ${taskId}`);
                return;
            }

            // --- UI Update: Start Timer ---
            if (visitButton) visitButton.style.display = 'none';
            timerSection.style.display = 'flex'; // Show the timer/claim container
            timerSpan.textContent = `Wait ${TASK_TIMER_DURATION}s`;
            timerSpan.style.display = 'inline'; // Show timer text
            claimButton.style.display = 'none'; // Hide claim button initially
            claimButton.disabled = true;        // Disable claim button

            // --- Open Link (if exists) ---
            let linkOpenedSuccessfully = true; // Assume success if no link
            if (taskLink) {
                try {
                    const openedWindow = window.open(taskLink, '_blank', 'noopener,noreferrer');
                    if (!openedWindow || openedWindow.closed || typeof openedWindow.closed === 'undefined') {
                        // Pop-up likely blocked
                        linkOpenedSuccessfully = false;
                        alert("Pop-up blocked or failed to open. Please manually visit the task link (if provided) or check browser settings. Timer will continue.");
                         // Optional: Revert UI? For now, let timer run, user might visit manually.
                         // if (visitButton) visitButton.style.display = 'inline-block';
                         // timerSection.style.display = 'none';
                         // return; // Stop if link opening is mandatory?
                    }
                } catch (e) {
                    linkOpenedSuccessfully = false;
                    console.error("Error opening task link:", e);
                    alert("Could not open the task link automatically. Please check your browser settings. Timer will continue.");
                    // Optional: Revert UI or stop timer as above?
                }
            } else {
                console.warn("No link provided for task:", taskId);
                // No link to open, timer runs as normal.
            }

            // --- Start Countdown ---
            let remainingTime = TASK_TIMER_DURATION;
            const intervalId = setInterval(() => {
                // Ensure the task element still exists in the DOM (user might navigate away)
                 const currentTaskElement = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
                 if (!currentTaskElement) {
                     clearInterval(intervalId); // Stop timer if element is gone
                     delete activeTaskTimers[taskId]; // Clean up tracker
                     console.log("Task element removed, stopping timer for", taskId);
                     return;
                 }

                remainingTime--;
                const currentTimerSpan = currentTaskElement.querySelector('.timer'); // Re-select in case of DOM changes
                if (currentTimerSpan) {
                     currentTimerSpan.textContent = `Wait ${remainingTime}s`;
                }


                if (remainingTime <= 0) {
                    clearInterval(intervalId); // Stop the interval
                    delete activeTaskTimers[taskId]; // Clean up tracker

                     const currentClaimButton = currentTaskElement.querySelector('.claim-button');
                     if (currentTimerSpan) currentTimerSpan.style.display = 'none'; // Hide timer text

                    if (currentClaimButton) {
                        currentClaimButton.textContent = `Claim +${taskPoints} Pts`;
                        currentClaimButton.style.display = 'inline-block'; // Show claim button
                        currentClaimButton.disabled = false; // Enable claim button
                        // Assign the claim function directly to this specific button instance
                        currentClaimButton.onclick = () => claimDynamicTaskPoints(taskId, taskPoints);
                    } else {
                         console.error(`Claim button not found for task ${taskId} after timer.`);
                    }
                }
            }, 1000); // Run every second

            // Store interval ID in the tracker
            activeTaskTimers[taskId] = intervalId;
        }
        window.startTaskTimer = startTaskTimer; // Expose to global scope for onclick

        async function claimDynamicTaskPoints(taskId, pointsValue) {
            if (!currentUserId) return;
            if (completedTaskKeys.has(taskId)) { console.log("Task already claimed:", taskId); return; }

            const taskElement = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
            const claimButton = taskElement?.querySelector('.claim-button');
            const timerSection = taskElement?.querySelector('.timer-claim-section'); // The container for timer/claim/completed message
            const taskActionsDiv = taskElement?.querySelector('.task-actions'); // General actions container

            if (claimButton) {
                claimButton.disabled = true;
                claimButton.textContent = 'Claiming...';
            } else {
                 console.warn(`Claim button not found during claim for task ${taskId}`);
                 // Proceed with logic anyway, UI update might fail gracefully
            }


            const userRef = ref(db, `users/${currentUserId}`);
            const taskCompletedRef = ref(db, `users/${currentUserId}/completedTasks/${taskId}`);

            try {
                 // Double-check completion status in DB before proceeding
                 const completedSnapshot = await get(taskCompletedRef);
                 if (completedSnapshot.exists() && completedSnapshot.val() === true) {
                     console.log("Task already marked as completed in DB (race condition?):", taskId);
                     completedTaskKeys.add(taskId); // Ensure local state is synced
                     if (taskActionsDiv) taskActionsDiv.innerHTML = '<span class="completed-message">Completed</span>'; // Update UI
                     return;
                 }

                // Use update with a transaction for points
                await update(userRef, {
                   [`points`]: runTransaction(ref(db, `users/${currentUserId}/points`), (currentPoints) => {
                       return (currentPoints || 0) + pointsValue;
                   }),
                   [`completedTasks/${taskId}`]: true // Mark task as completed
                });

                 // Update local state immediately after successful DB update
                 completedTaskKeys.add(taskId);

                 // Update UI to show completed status cleanly
                 if (taskActionsDiv) { // Target the main actions container
                     taskActionsDiv.innerHTML = '<span class="completed-message">Completed</span>';
                 } else if (timerSection) { // Fallback to timer section if actions div not found
                     timerSection.innerHTML = '<span class="completed-message">Completed</span>';
                 }

                 alert(`Task completed! You earned ${pointsValue} points.`);

                 // Points display will update via the 'points' listener.
                 // Withdraw button state will also update via the 'points' listener.

            } catch (error) {
                console.error("Error claiming task points:", error);
                alert(`Failed to claim points: ${error.message || 'Please try again.'}`);
                // Re-enable claim button ONLY if the error occurred and task is still not marked completed locally
                if (claimButton && !completedTaskKeys.has(taskId)) {
                    claimButton.disabled = false;
                    claimButton.textContent = `Claim +${pointsValue} Pts`;
                }
            }
        }
        // claimDynamicTaskPoints is called internally by the onclick handler set in startTaskTimer

       // --- Modals ---
        function openBuyModal(coinName) {
            if (!buyModal || !buyCoinNameSpan || !buyForm) return;
            buyCoinNameSpan.textContent = coinName;
            buyForm.reset(); // Clear previous inputs
            // Clear any potential previous error messages in the modal form if added
            // const errorDiv = buyForm.querySelector('.error-message');
            // if(errorDiv) errorDiv.textContent = '';
            buyModal.classList.add('show');
        }
        window.openBuyModal = openBuyModal;

        function openSellModal(coinName) {
             if (!sellModal || !sellCoinNameSpan || !sellForm || !dealerAddressInfoDiv) return;
             sellCoinNameSpan.textContent = coinName;
             sellForm.reset(); // Clear previous inputs

             // Display the correct dealer address based on the coin name
             const address = dealerAddresses[coinName];
             const sellSubmitButton = sellForm.querySelector('button[type="submit"]');

             if (address) {
                 dealerAddressInfoDiv.innerHTML = `
                     <p>Send <strong>${coinName}</strong> to the address below:</p>
                     <p class="address">${address}</p>
                     <p style="margin-top:10px; font-size:0.9em; color: var(--text-medium);"><strong>Important:</strong> After sending, enter the Transaction ID/Hash below & submit.</p>
                 `;
                 if(sellSubmitButton) sellSubmitButton.disabled = false; // Ensure button is enabled
             } else {
                 dealerAddressInfoDiv.innerHTML = `<p style="color: var(--danger-color);">âŒ Dealer address for ${coinName} is currently unavailable. Selling is disabled for this coin. Please contact support.</p>`;
                 // Disable the submit button if address is missing
                 if(sellSubmitButton) sellSubmitButton.disabled = true;
             }
             sellModal.classList.add('show');
        }
        window.openSellModal = openSellModal;

        function openWithdrawModal() {
            if (!currentUserId) {
                alert("Please log in to withdraw points.");
                return;
            }
            if (!withdrawModal || !withdrawForm || !withdrawCurrentPointsSpan || !withdrawMinimumPointsSpan || !withdrawMessageDiv) return;

            // Update display values with formatting
            const formattedUserPoints = userPoints.toLocaleString();
            const formattedMinPoints = MIN_WITHDRAWAL_POINTS.toLocaleString();
            withdrawCurrentPointsSpan.textContent = formattedUserPoints;
            withdrawMinimumPointsSpan.textContent = formattedMinPoints; // Display min points
            withdrawMessageDiv.textContent = ''; // Clear previous messages

            const amountInput = document.getElementById('withdraw-amount');
            if (amountInput) {
                amountInput.min = MIN_WITHDRAWAL_POINTS;
                amountInput.max = userPoints; // Set max value dynamically
                amountInput.placeholder = `Min ${formattedMinPoints}, Max ${formattedUserPoints}`;
            }

            // Check if user has enough points before showing modal fully
            if (userPoints < MIN_WITHDRAWAL_POINTS) {
                alert(`You need at least ${formattedMinPoints} points to make a withdrawal request. Your current balance is ${formattedUserPoints}. Earn more points!`);
                return; // Don't open modal if not enough points
            }

            withdrawForm.reset(); // Clear previous inputs
            withdrawModal.classList.add('show');
        }
        window.openWithdrawModal = openWithdrawModal;

        function openProfileModal() {
             if (!currentUserId) {
                 alert("Please log in to view your profile.");
                 return;
             }
             if (!profileModal || !profileModalUserName || !profileModalUserEmail || !profileModalUserPoints) return;

             // Update profile info using current state variables
             profileModalUserName.textContent = currentUserName || "Loading...";
             profileModalUserEmail.textContent = currentUserEmail || "Loading...";
             profileModalUserPoints.textContent = userPoints.toLocaleString(); // Use formatted points

             profileModal.classList.add('show');
        }
        window.openProfileModal = openProfileModal;

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                 // Optional: Reset form inside modal when closing
                 const form = modal.querySelector('form');
                 if (form) {
                    form.reset();
                 }
                 // Optional: Clear error messages inside modal
                 const errorDiv = modal.querySelector('.error-message');
                 if(errorDiv) errorDiv.textContent = '';
            }
        }
        window.closeModal = closeModal; // Make globally accessible

       // --- Modal Submit Handlers (Save to DB) ---
        async function handleBuySubmit(event) {
            event.preventDefault();
            if (!currentUserId) { alert("You must be logged in to submit a buy order."); return; }
            if (!buyForm) return;

            const submitButton = buyForm.querySelector('button[type="submit"]');
            if (submitButton) { submitButton.disabled = true; submitButton.textContent = "Submitting..."; }

            const coinName = buyCoinNameSpan?.textContent || 'Unknown Coin';
            const formData = new FormData(buyForm);

            // Simple validation for required fields
            const quantity = formData.get('quantity');
            const receivingAddress = formData.get('receivingAddress');
            const walletName = formData.get('walletName');
            const paymentMethod = formData.get('paymentMethod');
            const accountName = formData.get('accountName');
            const accountNumber = formData.get('accountNumber');
            const transactionId = formData.get('transactionId');

            if (!quantity || !receivingAddress || !walletName || !paymentMethod || !accountName || !accountNumber || !transactionId) {
                 alert("Please fill in all required fields.");
                 if (submitButton) { submitButton.disabled = false; submitButton.textContent = "Submit Buy Order"; }
                 return;
            }

            // Prepare data object for Firebase
            const orderData = {
                userId: currentUserId,
                userName: currentUserName || null, // Include user's name if available
                userEmail: currentUserEmail || null, // Include user's email
                coinName: coinName,
                quantity: Number(quantity), // Store as number if possible
                receivingAddress: receivingAddress,
                walletName: walletName,
                paymentMethod: paymentMethod,
                senderAccountName: accountName,
                senderAccountNumber: accountNumber,
                transactionId: transactionId,
                // transactionPhoto: // File uploads require Firebase Storage - skipping for this example
                status: "pending", // Initial status, admin needs to verify payment and update
                timestamp: serverTimestamp() // Use server time for consistency
            };

            try {
                const buyOrdersRef = ref(db, 'buyOrders');
                await set(push(buyOrdersRef), orderData); // push() generates a unique ID

                alert("Buy order submitted successfully! Your request is pending review by the admin.");
                closeModal('buyModal'); // Close modal on success

                // Refresh history if user is currently viewing it
                const historyPage = document.getElementById('page-history');
                if (historyPage && historyPage.classList.contains('active')) {
                     loadHistoryData();
                }

            } catch (error) {
                console.error("Error submitting buy order:", error);
                alert("Failed to submit buy order. Please check your connection and try again.");
                // Consider showing error message within the modal
            } finally {
                // Re-enable button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = "Submit Buy Order";
                }
            }
        }
        window.handleBuySubmit = handleBuySubmit;

        async function handleSellSubmit(event) {
            event.preventDefault();
             if (!currentUserId) { alert("You must be logged in to submit a sell order."); return; }
             if (!sellForm) return;

            const submitButton = sellForm.querySelector('button[type="submit"]');
            if (submitButton) { submitButton.disabled = true; submitButton.textContent = "Submitting..."; }

             const coinName = sellCoinNameSpan?.textContent || 'Unknown Coin';
             const formData = new FormData(sellForm);

             // Simple validation
            const quantity = formData.get('quantity');
            const cryptoTxHash = formData.get('cryptoTxHash');
            const paymentMethod = formData.get('paymentMethod');
            const accountName = formData.get('accountName');
            const accountNumber = formData.get('accountNumber');

             if (!quantity || !cryptoTxHash || !paymentMethod || !accountName || !accountNumber) {
                  alert("Please fill in all required fields, including the Crypto Transaction Hash.");
                  if (submitButton) { submitButton.disabled = false; submitButton.textContent = "Submit Sell Order"; }
                  return;
             }


             // Prepare data object
             const orderData = {
                 userId: currentUserId,
                 userName: currentUserName || null,
                 userEmail: currentUserEmail || null,
                 coinName: coinName,
                 quantity: Number(quantity),
                 cryptoTxHash: cryptoTxHash, // Hash of crypto sent by user to dealer
                 paymentMethod: paymentMethod, // Where user wants to receive payment (e.g., Easypaisa)
                 receiverAccountName: accountName, // User's account name for receiving payment
                 receiverAccountNumber: accountNumber, // User's account number for receiving payment
                 status: "pending", // Admin needs to verify crypto receipt and update
                 timestamp: serverTimestamp()
             };

             try {
                 const sellOrdersRef = ref(db, 'sellOrders');
                 await set(push(sellOrdersRef), orderData);

                 alert("Sell order submitted successfully! Your request is pending review after crypto transaction verification.");
                 closeModal('sellModal');

                 // Refresh history if active
                 const historyPage = document.getElementById('page-history');
                 if (historyPage && historyPage.classList.contains('active')) {
                      loadHistoryData();
                 }

             } catch (error) {
                 console.error("Error submitting sell order:", error);
                 alert("Failed to submit sell order. Please check your details and try again.");
             } finally {
                 if (submitButton) {
                     submitButton.disabled = false;
                     submitButton.textContent = "Submit Sell Order";
                 }
             }
        }
        window.handleSellSubmit = handleSellSubmit;

        async function handleWithdrawSubmit(event) {
             event.preventDefault();
             if (!currentUserId) { alert("You must be logged in to submit a withdrawal request."); return; }
             if (!withdrawForm || !withdrawMessageDiv) return;

             withdrawMessageDiv.textContent = ''; // Clear previous messages

             const amountInput = document.getElementById('withdraw-amount');
             const methodSelect = document.getElementById('withdraw-method');
             const nameInput = document.getElementById('withdraw-account-name');
             const numberInput = document.getElementById('withdraw-account-number');

             const paymentMethod = methodSelect?.value;
             const accountName = nameInput?.value.trim();
             const accountNumber = numberInput?.value.trim();
             const amountToWithdraw = parseInt(amountInput?.value || '0');

             // --- Input Validation ---
             if (isNaN(amountToWithdraw) || amountToWithdraw < MIN_WITHDRAWAL_POINTS) {
                 withdrawMessageDiv.textContent = `Minimum withdrawal is ${MIN_WITHDRAWAL_POINTS.toLocaleString()} points.`;
                 return;
             }
             if (amountToWithdraw > userPoints) {
                 withdrawMessageDiv.textContent = `Insufficient points. You have ${userPoints.toLocaleString()}.`;
                 return;
             }
             if (!paymentMethod) { withdrawMessageDiv.textContent = 'Please select a payment method.'; return; }
             if (!accountName) { withdrawMessageDiv.textContent = 'Please enter the account holder name.'; return; }
             if (!accountNumber) { withdrawMessageDiv.textContent = 'Please enter the account number.'; return; }

             // Basic validation for Pakistani mobile numbers (allowing spaces, removing them for check)
             if ((paymentMethod === 'Easypaisa' || paymentMethod === 'Jazzcash')) {
                const cleanedNumber = accountNumber.replace(/\s+/g, '');
                if (!/^(03|\+923)\d{9}$/.test(cleanedNumber)) {
                     withdrawMessageDiv.textContent = `Please enter a valid ${paymentMethod} account number (e.g., 03xxxxxxxxx or +923xxxxxxxxx).`;
                     return;
                }
             }
             // Add basic IBAN validation if needed (adjust regex as needed for specific formats)
             // if (paymentMethod === 'Bank Transfer' && !/^[A-Z]{2}\d{2}[A-Z\d]{11,30}$/.test(accountNumber.toUpperCase())) {
             //     withdrawMessageDiv.textContent = 'Please enter a valid Bank Account Number / IBAN.';
             //     return;
             // }

             const submitButton = withdrawForm.querySelector('button[type="submit"]');
             if (submitButton) { submitButton.disabled = true; submitButton.textContent = 'Submitting...'; }

             // --- Prepare Data ---
             // *** IMPORTANT: Point deduction MUST happen securely after admin approval. ***
             // *** This function ONLY records the request. Admin needs separate interface/function. ***
             const requestData = {
                 userId: currentUserId,
                 userName: currentUserName || null,
                 userEmail: currentUserEmail || null,
                 pointsAmount: amountToWithdraw, // Amount requested
                 paymentMethod: paymentMethod,
                 receiverAccountName: accountName,
                 receiverAccountNumber: accountNumber, // Store the number as entered by user
                 status: "pending", // Initial status, needs admin action
                 timestamp: serverTimestamp()
             };

             try {
                 const withdrawalRequestsRef = ref(db, 'withdrawalRequests');
                 await set(push(withdrawalRequestsRef), requestData);

                 alert(`Withdrawal request for ${amountToWithdraw.toLocaleString()} points submitted successfully. Admin will review and process. Points are deducted only upon approval.`);
                 closeModal('withdrawModal');

                 // Refresh history if active
                 const historyPage = document.getElementById('page-history');
                 if (historyPage && historyPage.classList.contains('active')) {
                      loadHistoryData();
                 }

             } catch (error) {
                 console.error("Error submitting withdrawal request:", error);
                 withdrawMessageDiv.textContent = 'Failed to submit request. Please try again.';
                 alert("Failed to submit withdrawal request.");
             } finally {
                 if (submitButton) {
                     submitButton.disabled = false;
                     submitButton.textContent = 'Submit Withdrawal Request';
                 }
             }
        }
        window.handleWithdrawSubmit = handleWithdrawSubmit;


       // --- WhatsApp FAB Action ---
       function openWhatsApp() {
           // *** Replace with YOUR actual phone number including country code ***
           const phoneNumber = "923085251502"; // Example: Pakistan number (Replace!)
           const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent('Hello Nadeem Raza Trust Dealer, I need help with the crypto app.')}`; // Optional pre-filled message
           window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
       }
       window.openWhatsApp = openWhatsApp;

       // --- Initial Setup ---
       // Close modal if clicked on the background overlay
       window.onclick = function(event) {
           if (event.target.classList.contains('modal') && event.target.classList.contains('show')) {
               closeModal(event.target.id);
           }
       }
       // Set minimum withdrawal points display initially (static part)
       if(withdrawMinimumPointsSpan) withdrawMinimumPointsSpan.textContent = MIN_WITHDRAWAL_POINTS.toLocaleString();
       // Initial check for referral code prefill when auth page might be visible
       checkReferralAndPrefill();

    </script>
</body>
</html>